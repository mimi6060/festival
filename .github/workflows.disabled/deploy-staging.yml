# =============================================================================
# Deploy Staging - Festival Platform
# =============================================================================
# Automatic deployment to staging environment on develop branch push
# Deploys API, Web, and Admin applications to staging infrastructure
# =============================================================================

name: Deploy Staging

on:
  push:
    branches: [develop]
  workflow_dispatch:
    inputs:
      deploy_api:
        description: 'Deploy API'
        required: false
        default: true
        type: boolean
      deploy_web:
        description: 'Deploy Web'
        required: false
        default: true
        type: boolean
      deploy_admin:
        description: 'Deploy Admin'
        required: false
        default: true
        type: boolean
      run_migrations:
        description: 'Run database migrations'
        required: false
        default: true
        type: boolean

concurrency:
  group: deploy-staging
  cancel-in-progress: false

env:
  ENVIRONMENT: staging
  AWS_REGION: ${{ vars.AWS_REGION || 'eu-west-1' }}
  ECR_REGISTRY: ${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.${{ vars.AWS_REGION || 'eu-west-1' }}.amazonaws.com
  CLUSTER_NAME: festival-staging
  NODE_OPTIONS: --max-old-space-size=4096

jobs:
  # ===========================================================================
  # Pre-deployment checks
  # ===========================================================================
  pre-deploy:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    outputs:
      deploy-api: ${{ steps.check.outputs.deploy-api }}
      deploy-web: ${{ steps.check.outputs.deploy-web }}
      deploy-admin: ${{ steps.check.outputs.deploy-admin }}
      version: ${{ steps.version.outputs.version }}
      short-sha: ${{ steps.version.outputs.short-sha }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version info
        id: version
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          VERSION="staging-${SHORT_SHA}-$(date +%Y%m%d%H%M%S)"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "short-sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Determine what to deploy
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "deploy-api=${{ inputs.deploy_api }}" >> $GITHUB_OUTPUT
            echo "deploy-web=${{ inputs.deploy_web }}" >> $GITHUB_OUTPUT
            echo "deploy-admin=${{ inputs.deploy_admin }}" >> $GITHUB_OUTPUT
          else
            # Check affected projects on push
            npm ci --prefer-offline --no-audit
            npx nrwl/nx-set-shas@v4

            if npx nx show projects --affected | grep -q "api"; then
              echo "deploy-api=true" >> $GITHUB_OUTPUT
            else
              echo "deploy-api=false" >> $GITHUB_OUTPUT
            fi

            if npx nx show projects --affected | grep -q "web"; then
              echo "deploy-web=true" >> $GITHUB_OUTPUT
            else
              echo "deploy-web=false" >> $GITHUB_OUTPUT
            fi

            if npx nx show projects --affected | grep -q "admin"; then
              echo "deploy-admin=true" >> $GITHUB_OUTPUT
            else
              echo "deploy-admin=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Notify deployment start
        run: |
          echo "## Staging Deployment Starting" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Deploy |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${{ steps.check.outputs.deploy-api }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Web | ${{ steps.check.outputs.deploy-web }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Admin | ${{ steps.check.outputs.deploy-admin }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Run Database Migrations
  # ===========================================================================
  migrate-database:
    name: Database Migrations
    runs-on: ubuntu-latest
    needs: pre-deploy
    if: ${{ github.event_name == 'push' || inputs.run_migrations }}
    environment: staging
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Run migrations
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}

      - name: Verify migration status
        run: npx prisma migrate status
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}

  # ===========================================================================
  # Build and Deploy API
  # ===========================================================================
  deploy-api:
    name: Deploy API
    runs-on: ubuntu-latest
    needs: [pre-deploy, migrate-database]
    if: ${{ needs.pre-deploy.outputs.deploy-api == 'true' }}
    environment:
      name: staging
      url: https://api-staging.festival.io
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: docker-api-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            docker-api-${{ runner.os }}-

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/api/Dockerfile
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/festival-api:${{ needs.pre-deploy.outputs.version }}
            ${{ env.ECR_REGISTRY }}/festival-api:staging-latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          build-args: |
            NODE_ENV=production
            BUILD_VERSION=${{ needs.pre-deploy.outputs.version }}

      - name: Move Docker cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache || true

      - name: Deploy to ECS
        run: |
          aws ecs update-service \
            --cluster ${{ env.CLUSTER_NAME }} \
            --service festival-api-staging \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Wait for deployment
        run: |
          aws ecs wait services-stable \
            --cluster ${{ env.CLUSTER_NAME }} \
            --services festival-api-staging \
            --region ${{ env.AWS_REGION }}
        timeout-minutes: 10

      - name: Health check
        run: |
          sleep 30
          for i in {1..5}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://api-staging.festival.io/health || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "API is healthy!"
              exit 0
            fi
            echo "Attempt $i: HTTP status $HTTP_STATUS, retrying in 10s..."
            sleep 10
          done
          echo "Health check failed after 5 attempts"
          exit 1

  # ===========================================================================
  # Build and Deploy Web
  # ===========================================================================
  deploy-web:
    name: Deploy Web
    runs-on: ubuntu-latest
    needs: [pre-deploy, migrate-database]
    if: ${{ needs.pre-deploy.outputs.deploy-web == 'true' }}
    environment:
      name: staging
      url: https://staging.festival.io
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Build Web application
        run: NODE_ENV=production npx nx build web
        env:
          NEXT_PUBLIC_API_URL: https://api-staging.festival.io
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.STAGING_STRIPE_PUBLISHABLE_KEY }}
          NEXT_TELEMETRY_DISABLED: 1

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID_WEB }}
          working-directory: ./dist/apps/web
          alias-domains: |
            staging.festival.io

      - name: Health check
        run: |
          sleep 15
          for i in {1..5}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://staging.festival.io || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "Web app is healthy!"
              exit 0
            fi
            echo "Attempt $i: HTTP status $HTTP_STATUS, retrying in 10s..."
            sleep 10
          done
          echo "Health check failed after 5 attempts"
          exit 1

  # ===========================================================================
  # Build and Deploy Admin
  # ===========================================================================
  deploy-admin:
    name: Deploy Admin
    runs-on: ubuntu-latest
    needs: [pre-deploy, migrate-database]
    if: ${{ needs.pre-deploy.outputs.deploy-admin == 'true' }}
    environment:
      name: staging
      url: https://admin-staging.festival.io
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Build Admin application
        run: NODE_ENV=production npx nx build admin
        env:
          NEXT_PUBLIC_API_URL: https://api-staging.festival.io
          NEXT_TELEMETRY_DISABLED: 1

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID_ADMIN }}
          working-directory: ./dist/apps/admin
          alias-domains: |
            admin-staging.festival.io

      - name: Health check
        run: |
          sleep 15
          for i in {1..5}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://admin-staging.festival.io || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "Admin app is healthy!"
              exit 0
            fi
            echo "Attempt $i: HTTP status $HTTP_STATUS, retrying in 10s..."
            sleep 10
          done
          echo "Health check failed after 5 attempts"
          exit 1

  # ===========================================================================
  # Run Smoke Tests
  # ===========================================================================
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-web, deploy-admin]
    if: always() && (needs.deploy-api.result == 'success' || needs.deploy-web.result == 'success' || needs.deploy-admin.result == 'success')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Run API smoke tests
        if: needs.deploy-api.result == 'success'
        run: |
          # Health endpoint
          curl -f https://api-staging.festival.io/health

          # API docs
          curl -f https://api-staging.festival.io/api/docs

          # Metrics (internal)
          curl -f https://api-staging.festival.io/monitoring/status || true

      - name: Run Web smoke tests
        if: needs.deploy-web.result == 'success'
        run: |
          # Homepage
          curl -f https://staging.festival.io

          # Check for required meta tags
          curl -s https://staging.festival.io | grep -q '<title>' || exit 1

      - name: Run Admin smoke tests
        if: needs.deploy-admin.result == 'success'
        run: |
          # Admin login page
          curl -f https://admin-staging.festival.io/login || true

  # ===========================================================================
  # Notify Deployment Status
  # ===========================================================================
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [pre-deploy, deploy-api, deploy-web, deploy-admin, smoke-tests]
    if: always()
    steps:
      - name: Create deployment summary
        run: |
          echo "## Staging Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.pre-deploy.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${{ needs.deploy-api.result }} | https://api-staging.festival.io |" >> $GITHUB_STEP_SUMMARY
          echo "| Web | ${{ needs.deploy-web.result }} | https://staging.festival.io |" >> $GITHUB_STEP_SUMMARY
          echo "| Admin | ${{ needs.deploy-admin.result }} | https://admin-staging.festival.io |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.smoke-tests.result }} | - |" >> $GITHUB_STEP_SUMMARY

      - name: Notify Slack on success
        if: ${{ needs.deploy-api.result == 'success' || needs.deploy-web.result == 'success' || needs.deploy-admin.result == 'success' }}
        run: |
          echo "Deployment to staging successful!"
          # Uncomment to enable Slack notifications:
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{
          #     "text": "Staging deployment completed successfully!",
          #     "attachments": [{
          #       "color": "good",
          #       "fields": [
          #         {"title": "Version", "value": "${{ needs.pre-deploy.outputs.version }}", "short": true},
          #         {"title": "API", "value": "${{ needs.deploy-api.result }}", "short": true},
          #         {"title": "Web", "value": "${{ needs.deploy-web.result }}", "short": true},
          #         {"title": "Admin", "value": "${{ needs.deploy-admin.result }}", "short": true}
          #       ]
          #     }]
          #   }' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on failure
        if: ${{ needs.deploy-api.result == 'failure' || needs.deploy-web.result == 'failure' || needs.deploy-admin.result == 'failure' }}
        run: |
          echo "Deployment to staging failed!"
          # Uncomment to enable Slack notifications:
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{
          #     "text": "Staging deployment FAILED!",
          #     "attachments": [{
          #       "color": "danger",
          #       "fields": [
          #         {"title": "Version", "value": "${{ needs.pre-deploy.outputs.version }}", "short": true},
          #         {"title": "API", "value": "${{ needs.deploy-api.result }}", "short": true},
          #         {"title": "Web", "value": "${{ needs.deploy-web.result }}", "short": true},
          #         {"title": "Admin", "value": "${{ needs.deploy-admin.result }}", "short": true}
          #       ]
          #     }]
          #   }' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}
