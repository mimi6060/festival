# =============================================================================
# CD Pipeline - Festival Platform
# =============================================================================
# Continuous Deployment pipeline for Kubernetes
# Triggers on:
#   - Push to main (production)
#   - Push to develop (staging)
#   - Manual workflow dispatch
# =============================================================================

name: CD

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'apps/**'
      - 'libs/**'
      - 'prisma/**'
      - 'package.json'
      - 'package-lock.json'
      - 'k8s/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      version:
        description: 'Version tag (leave empty for auto)'
        required: false
        type: string

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/festival

jobs:
  # ===========================================================================
  # Determine Environment
  # ===========================================================================
  prepare:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      version: ${{ steps.version.outputs.version }}
      sha_short: ${{ steps.version.outputs.sha_short }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

      - name: Generate version
        id: version
        run: |
          SHA_SHORT=$(git rev-parse --short HEAD)
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="v$(date +%Y%m%d)-${SHA_SHORT}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "sha_short=${SHA_SHORT}" >> $GITHUB_OUTPUT

  # ===========================================================================
  # Build and Push Docker Images
  # ===========================================================================
  build-images:
    name: Build Images
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      matrix:
        app: [api, web, admin]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.app }}
          tags: |
            type=raw,value=${{ needs.prepare.outputs.version }}
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=sha,prefix=sha-

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/${{ matrix.app }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production
            BUILD_VERSION=${{ needs.prepare.outputs.version }}

  # ===========================================================================
  # Run Database Migrations
  # ===========================================================================
  migrate:
    name: Database Migration
    runs-on: ubuntu-latest
    needs: [prepare, build-images]
    environment: ${{ needs.prepare.outputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'

      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > kubeconfig.yaml
          echo "KUBECONFIG=$(pwd)/kubeconfig.yaml" >> $GITHUB_ENV

      - name: Run migrations
        run: |
          NAMESPACE="festival-${{ needs.prepare.outputs.environment }}"

          # Create migration job
          cat <<EOF | kubectl apply -f -
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: prisma-migrate-${{ needs.prepare.outputs.sha_short }}
            namespace: ${NAMESPACE}
          spec:
            ttlSecondsAfterFinished: 300
            template:
              spec:
                restartPolicy: Never
                containers:
                  - name: migrate
                    image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-api:${{ needs.prepare.outputs.version }}
                    command: ["npx", "prisma", "migrate", "deploy"]
                    envFrom:
                      - secretRef:
                          name: festival-secrets
                      - configMapRef:
                          name: festival-config
          EOF

          # Wait for job completion
          kubectl wait --for=condition=complete \
            --timeout=300s \
            job/prisma-migrate-${{ needs.prepare.outputs.sha_short }} \
            -n ${NAMESPACE}

  # ===========================================================================
  # Deploy to Kubernetes
  # ===========================================================================
  deploy:
    name: Deploy to ${{ needs.prepare.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [prepare, build-images, migrate]
    environment: ${{ needs.prepare.outputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'

      - name: Install kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > kubeconfig.yaml
          echo "KUBECONFIG=$(pwd)/kubeconfig.yaml" >> $GITHUB_ENV

      - name: Update image tags
        run: |
          cd k8s/overlays/${{ needs.prepare.outputs.environment }}

          kustomize edit set image \
            festival/api=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-api:${{ needs.prepare.outputs.version }} \
            festival/web=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-web:${{ needs.prepare.outputs.version }} \
            festival/admin=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-admin:${{ needs.prepare.outputs.version }}

      - name: Deploy with kustomize
        run: |
          kustomize build k8s/overlays/${{ needs.prepare.outputs.environment }} | kubectl apply -f -

      - name: Wait for rollout
        run: |
          NAMESPACE="festival-${{ needs.prepare.outputs.environment }}"

          kubectl rollout status deployment/api -n ${NAMESPACE} --timeout=300s
          kubectl rollout status deployment/web -n ${NAMESPACE} --timeout=300s
          kubectl rollout status deployment/admin -n ${NAMESPACE} --timeout=300s

      - name: Verify deployment
        run: |
          NAMESPACE="festival-${{ needs.prepare.outputs.environment }}"

          # Check pod status
          kubectl get pods -n ${NAMESPACE} -l app.kubernetes.io/part-of=festival-platform

          # Run health check
          API_POD=$(kubectl get pod -n ${NAMESPACE} -l app.kubernetes.io/name=api -o jsonpath='{.items[0].metadata.name}')
          kubectl exec -n ${NAMESPACE} ${API_POD} -- curl -sf http://localhost:3333/api/health || exit 1

  # ===========================================================================
  # Post-Deployment Notifications
  # ===========================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [prepare, deploy]
    if: always()
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
        with:
          payload: |
            {
              "text": "Deployment ${{ needs.deploy.result == 'success' && '✅ Succeeded' || '❌ Failed' }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Festival Platform Deployment*\n\n*Environment:* ${{ needs.prepare.outputs.environment }}\n*Version:* ${{ needs.prepare.outputs.version }}\n*Status:* ${{ needs.deploy.result == 'success' && '✅ Success' || '❌ Failed' }}\n*Triggered by:* ${{ github.actor }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ===========================================================================
  # Rollback (Manual)
  # ===========================================================================
  rollback:
    name: Rollback
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && failure() }}
    needs: [prepare, deploy]
    environment: ${{ needs.prepare.outputs.environment }}
    steps:
      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'

      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > kubeconfig.yaml
          echo "KUBECONFIG=$(pwd)/kubeconfig.yaml" >> $GITHUB_ENV

      - name: Rollback deployments
        run: |
          NAMESPACE="festival-${{ needs.prepare.outputs.environment }}"

          kubectl rollout undo deployment/api -n ${NAMESPACE}
          kubectl rollout undo deployment/web -n ${NAMESPACE}
          kubectl rollout undo deployment/admin -n ${NAMESPACE}

          kubectl rollout status deployment/api -n ${NAMESPACE} --timeout=300s
          kubectl rollout status deployment/web -n ${NAMESPACE} --timeout=300s
          kubectl rollout status deployment/admin -n ${NAMESPACE} --timeout=300s
