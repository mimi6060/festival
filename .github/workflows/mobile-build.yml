# =============================================================================
# Mobile Build - Festival React Native / Expo App
# =============================================================================
# Comprehensive mobile build pipeline for iOS and Android
# Features: EAS Build, local builds, store submission, OTA updates
# =============================================================================

name: Mobile Build

on:
  push:
    branches: [main, develop]
    paths:
      - 'apps/mobile/**'
      - 'libs/shared/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/mobile-build.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/mobile/**'
      - 'libs/shared/**'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - android
          - ios
      build_type:
        description: 'Build type'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - preview
          - production
      submit_to_store:
        description: 'Submit to App Store / Play Store'
        required: false
        default: false
        type: boolean
      ota_update:
        description: 'Publish OTA update only'
        required: false
        default: false
        type: boolean

concurrency:
  group: mobile-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
  NODE_OPTIONS: --max-old-space-size=4096
  WORKING_DIR: apps/mobile

jobs:
  # ===========================================================================
  # Setup and Validation
  # ===========================================================================
  setup:
    name: Setup & Validate
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build-number: ${{ steps.version.outputs.build-number }}
      should-build-android: ${{ steps.check.outputs.android }}
      should-build-ios: ${{ steps.check.outputs.ios }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version and build number
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="1.0.0-dev.$(git rev-parse --short HEAD)"
          fi
          BUILD_NUMBER=${{ github.run_number }}

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "build-number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}, Build: ${BUILD_NUMBER}"

      - name: Determine build targets
        id: check
        run: |
          PLATFORM="${{ inputs.platform || 'all' }}"
          if [[ "$PLATFORM" == "all" || "$PLATFORM" == "android" ]]; then
            echo "android=true" >> $GITHUB_OUTPUT
          else
            echo "android=false" >> $GITHUB_OUTPUT
          fi
          if [[ "$PLATFORM" == "all" || "$PLATFORM" == "ios" ]]; then
            echo "ios=true" >> $GITHUB_OUTPUT
          else
            echo "ios=false" >> $GITHUB_OUTPUT
          fi

  # ===========================================================================
  # Lint, Type Check & Unit Tests
  # ===========================================================================
  test:
    name: Lint & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.npm
          key: node-modules-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            node-modules-${{ runner.os }}-

      - name: Cache NX
        uses: actions/cache@v4
        with:
          path: .nx/cache
          key: nx-mobile-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ github.sha }}
          restore-keys: |
            nx-mobile-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-
            nx-mobile-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Lint mobile application
        run: npx nx lint mobile
        continue-on-error: true

      - name: Run type check
        run: npx nx run mobile:typecheck
        continue-on-error: true

      - name: Run unit tests
        run: npx nx test mobile --coverage --coverageReporters=lcov,text-summary
        continue-on-error: true

      - name: Upload test coverage
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/apps/mobile/lcov.info
          flags: mobile
          name: codecov-mobile
          fail_ci_if_error: false

  # ===========================================================================
  # OTA Update (Expo Updates)
  # ===========================================================================
  ota-update:
    name: OTA Update
    runs-on: ubuntu-latest
    needs: [setup, test]
    if: ${{ inputs.ota_update == true || (github.event_name == 'push' && github.ref == 'refs/heads/develop') }}
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Setup EAS
        run: npm install -g eas-cli

      - name: Publish OTA update
        run: |
          cd ${{ env.WORKING_DIR }}
          CHANNEL=${{ github.ref == 'refs/heads/main' && 'production' || 'preview' }}
          eas update --channel $CHANNEL --message "Update from commit ${{ github.sha }}" --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Notify OTA published
        run: |
          echo "OTA Update published to channel: ${{ github.ref == 'refs/heads/main' && 'production' || 'preview' }}"

  # ===========================================================================
  # Build Android APK/AAB
  # ===========================================================================
  build-android:
    name: Build Android (${{ inputs.build_type || 'development' }})
    runs-on: ubuntu-latest
    needs: [setup, test]
    if: ${{ needs.setup.outputs.should-build-android == 'true' && inputs.ota_update != true }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.android/build-cache
          key: gradle-${{ runner.os }}-${{ hashFiles('apps/mobile/android/**/*.gradle*', 'apps/mobile/android/**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Setup EAS CLI
        run: npm install -g eas-cli expo-cli

      - name: Login to Expo
        run: npx expo login --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        continue-on-error: true

      - name: Update version in app.json
        run: |
          cd ${{ env.WORKING_DIR }}
          jq '.expo.version = "${{ needs.setup.outputs.version }}" | .expo.android.versionCode = ${{ needs.setup.outputs.build-number }}' app.json > tmp.json
          mv tmp.json app.json

      # EAS Build for production
      - name: Build with EAS (Production)
        if: inputs.build_type == 'production' || github.event_name == 'release'
        run: |
          cd ${{ env.WORKING_DIR }}
          eas build --platform android --profile production --non-interactive --wait
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      # Local build for development/preview
      - name: Prebuild Android
        if: inputs.build_type != 'production' && github.event_name != 'release'
        run: |
          cd ${{ env.WORKING_DIR }}
          npx expo prebuild --platform android --clean

      - name: Decode Keystore
        if: inputs.build_type != 'production' && github.event_name != 'release'
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > ${{ env.WORKING_DIR }}/android/app/festival.keystore
        continue-on-error: true

      - name: Build Android APK (Debug)
        if: inputs.build_type == 'development'
        run: |
          cd ${{ env.WORKING_DIR }}/android
          ./gradlew assembleDebug

      - name: Build Android APK (Release)
        if: inputs.build_type == 'preview'
        run: |
          cd ${{ env.WORKING_DIR }}/android
          ./gradlew assembleRelease
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Build Android AAB (Production)
        if: inputs.build_type == 'production' && github.event_name != 'release'
        run: |
          cd ${{ env.WORKING_DIR }}/android
          ./gradlew bundleRelease
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ inputs.build_type || 'development' }}-${{ needs.setup.outputs.version }}
          path: |
            apps/mobile/android/app/build/outputs/apk/**/*.apk
            apps/mobile/android/app/build/outputs/bundle/**/*.aab
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload to Play Store (Internal)
        if: inputs.submit_to_store && (inputs.build_type == 'production' || github.event_name == 'release')
        run: |
          cd ${{ env.WORKING_DIR }}
          eas submit --platform android --profile production --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        continue-on-error: true

  # ===========================================================================
  # Build iOS IPA
  # ===========================================================================
  build-ios:
    name: Build iOS (${{ inputs.build_type || 'development' }})
    runs-on: macos-14
    needs: [setup, test]
    if: ${{ needs.setup.outputs.should-build-ios == 'true' && inputs.ota_update != true }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            apps/mobile/ios/Pods
            ~/Library/Caches/CocoaPods
            ~/.cocoapods
          key: pods-${{ runner.os }}-${{ hashFiles('apps/mobile/ios/Podfile.lock') }}
          restore-keys: |
            pods-${{ runner.os }}-

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: deriveddata-${{ runner.os }}-${{ hashFiles('apps/mobile/ios/**/*.pbxproj') }}
          restore-keys: |
            deriveddata-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Setup EAS CLI
        run: npm install -g eas-cli expo-cli

      - name: Login to Expo
        run: npx expo login --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        continue-on-error: true

      - name: Update version in app.json
        run: |
          cd ${{ env.WORKING_DIR }}
          jq '.expo.version = "${{ needs.setup.outputs.version }}" | .expo.ios.buildNumber = "${{ needs.setup.outputs.build-number }}"' app.json > tmp.json
          mv tmp.json app.json

      # EAS Build for production
      - name: Build with EAS (Production)
        if: inputs.build_type == 'production' || github.event_name == 'release'
        run: |
          cd ${{ env.WORKING_DIR }}
          eas build --platform ios --profile production --non-interactive --wait
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      # Local build for development/preview
      - name: Prebuild iOS
        if: inputs.build_type != 'production' && github.event_name != 'release'
        run: |
          cd ${{ env.WORKING_DIR }}
          npx expo prebuild --platform ios --clean

      - name: Install CocoaPods
        if: inputs.build_type != 'production' && github.event_name != 'release'
        run: |
          cd ${{ env.WORKING_DIR }}/ios
          pod install --repo-update

      - name: Setup iOS Signing
        if: inputs.build_type != 'production' && github.event_name != 'release'
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_P12_BASE64 }}
          p12-password: ${{ secrets.IOS_P12_PASSWORD }}
        continue-on-error: true

      - name: Install Provisioning Profile
        if: inputs.build_type != 'production' && github.event_name != 'release'
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
        continue-on-error: true

      - name: Build iOS Simulator (Development)
        if: inputs.build_type == 'development'
        run: |
          cd ${{ env.WORKING_DIR }}/ios
          xcodebuild -workspace Festival.xcworkspace \
            -scheme Festival \
            -sdk iphonesimulator \
            -configuration Debug \
            -derivedDataPath build

      - name: Build iOS Archive (Release)
        if: inputs.build_type == 'preview' || inputs.build_type == 'production'
        run: |
          cd ${{ env.WORKING_DIR }}/ios
          xcodebuild -workspace Festival.xcworkspace \
            -scheme Festival \
            -sdk iphoneos \
            -configuration Release \
            -archivePath $PWD/build/Festival.xcarchive \
            archive \
            CODE_SIGN_IDENTITY="${{ secrets.IOS_CODE_SIGN_IDENTITY }}" \
            PROVISIONING_PROFILE_SPECIFIER="${{ secrets.IOS_PROVISIONING_PROFILE_NAME }}" \
            DEVELOPMENT_TEAM="${{ secrets.IOS_TEAM_ID }}"
        continue-on-error: true

      - name: Export IPA
        if: (inputs.build_type == 'preview' || inputs.build_type == 'production') && github.event_name != 'release'
        run: |
          cd ${{ env.WORKING_DIR }}/ios
          # Create export options plist
          cat > ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>${{ inputs.build_type == 'production' && 'app-store' || 'ad-hoc' }}</string>
            <key>teamID</key>
            <string>${{ secrets.IOS_TEAM_ID }}</string>
          </dict>
          </plist>
          EOF
          xcodebuild -exportArchive \
            -archivePath $PWD/build/Festival.xcarchive \
            -exportPath $PWD/build \
            -exportOptionsPlist ExportOptions.plist
        continue-on-error: true

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ inputs.build_type || 'development' }}-${{ needs.setup.outputs.version }}
          path: |
            apps/mobile/ios/build/*.ipa
            apps/mobile/ios/build/*.app
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload to TestFlight
        if: inputs.submit_to_store && (inputs.build_type == 'production' || github.event_name == 'release')
        run: |
          cd ${{ env.WORKING_DIR }}
          eas submit --platform ios --profile production --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        continue-on-error: true

  # ===========================================================================
  # E2E Tests (Detox)
  # ===========================================================================
  e2e-tests:
    name: E2E Tests
    runs-on: macos-14
    needs: [build-ios]
    if: ${{ github.event_name == 'pull_request' && needs.build-ios.result == 'success' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Download iOS build
        uses: actions/download-artifact@v4
        with:
          name: ios-development-${{ needs.setup.outputs.version }}
          path: apps/mobile/ios/build
        continue-on-error: true

      - name: Install Detox
        run: |
          npm install -g detox-cli
          brew tap wix/brew
          brew install applesimutils
        continue-on-error: true

      - name: Run Detox E2E tests
        run: |
          cd ${{ env.WORKING_DIR }}
          detox test --configuration ios.sim.debug --cleanup
        continue-on-error: true

  # ===========================================================================
  # Notify Build Status
  # ===========================================================================
  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [setup, build-android, build-ios]
    if: always()
    steps:
      - name: Create build summary
        run: |
          echo "## Mobile Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status | Build Type |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Android | ${{ needs.build-android.result || 'skipped' }} | ${{ inputs.build_type || 'development' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS | ${{ needs.build-ios.result || 'skipped' }} | ${{ inputs.build_type || 'development' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.setup.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Number:** ${{ needs.setup.outputs.build-number }}" >> $GITHUB_STEP_SUMMARY

      - name: Notify Slack on success
        if: ${{ needs.build-android.result == 'success' || needs.build-ios.result == 'success' }}
        run: |
          echo "Mobile build completed successfully!"
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{
          #     "text": "Mobile build completed!",
          #     "attachments": [{
          #       "color": "good",
          #       "fields": [
          #         {"title": "Version", "value": "${{ needs.setup.outputs.version }}", "short": true},
          #         {"title": "Android", "value": "${{ needs.build-android.result }}", "short": true},
          #         {"title": "iOS", "value": "${{ needs.build-ios.result }}", "short": true}
          #       ]
          #     }]
          #   }' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify on failure
        if: ${{ needs.build-android.result == 'failure' || needs.build-ios.result == 'failure' }}
        run: |
          echo "Mobile build failed!"
          # Send failure notification
