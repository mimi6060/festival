# =============================================================================
# Release - Festival Monorepo
# =============================================================================
# Automated release workflow with semantic versioning
# Creates GitHub releases, changelogs, and notifies team
# Triggered by:
# - Push to main (creates release PR)
# - Tag push (creates GitHub release)
# - Manual trigger with version type selection
# =============================================================================

name: Release

on:
  push:
    branches: [main]
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - patch
          - minor
          - major
      skip_deploy:
        description: 'Skip deployment after release'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write
  packages: write

env:
  NODE_OPTIONS: --max-old-space-size=4096

jobs:
  # ===========================================================================
  # Release Please - Automated versioning and changelog
  # ===========================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: github.event_name != 'push' || !startsWith(github.ref, 'refs/tags/')
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      sha: ${{ steps.release.outputs.sha }}
    steps:
      - name: Create Release PR or Release
        id: release
        uses: google-github-actions/release-please-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          release-type: node
          package-name: "@festival/source"
          changelog-types: |
            [
              {"type": "feat", "section": "Features", "hidden": false},
              {"type": "fix", "section": "Bug Fixes", "hidden": false},
              {"type": "perf", "section": "Performance Improvements", "hidden": false},
              {"type": "revert", "section": "Reverts", "hidden": false},
              {"type": "docs", "section": "Documentation", "hidden": false},
              {"type": "style", "section": "Styles", "hidden": true},
              {"type": "chore", "section": "Miscellaneous", "hidden": true},
              {"type": "refactor", "section": "Code Refactoring", "hidden": true},
              {"type": "test", "section": "Tests", "hidden": true},
              {"type": "build", "section": "Build System", "hidden": true},
              {"type": "ci", "section": "CI/CD", "hidden": true}
            ]

  # ===========================================================================
  # Tag Release - When a tag is pushed directly
  # ===========================================================================
  tag-release:
    name: Tag Release
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    outputs:
      tag_name: ${{ steps.tag.outputs.tag }}
      version: ${{ steps.tag.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract tag info
        id: tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "First release, including all commits"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" HEAD)
          else
            echo "Generating changelog from $PREV_TAG to ${{ steps.tag.outputs.tag }}"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD)
          fi

          # Save to file for multiline handling
          echo "$CHANGELOG" > changelog.txt
          echo "Generated changelog with $(wc -l < changelog.txt) entries"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.version }}
          body_path: changelog.txt
          draft: false
          prerelease: ${{ contains(steps.tag.outputs.tag, '-') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Build Release Artifacts
  # ===========================================================================
  build-artifacts:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: [release, tag-release]
    if: |
      always() &&
      (needs.release.outputs.release_created == 'true' || needs.tag-release.result == 'success')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build all projects
        run: npx nx run-many -t build --all

      - name: Create build archive
        run: |
          VERSION=${{ needs.release.outputs.version || needs.tag-release.outputs.version }}
          tar -czf festival-$VERSION-dist.tar.gz dist/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            festival-*-dist.tar.gz
          retention-days: 90

      - name: Attach artifacts to release
        if: needs.release.outputs.release_created == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.release.outputs.tag_name }}
          files: festival-*-dist.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Post-Release Actions
  # ===========================================================================
  post-release:
    name: Post-Release Actions
    runs-on: ubuntu-latest
    needs: [release, tag-release, build-artifacts]
    if: |
      always() &&
      (needs.release.outputs.release_created == 'true' || needs.tag-release.result == 'success') &&
      github.event.inputs.skip_deploy != 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get release info
        id: info
        run: |
          if [ "${{ needs.release.outputs.version }}" != "" ]; then
            echo "version=${{ needs.release.outputs.version }}" >> $GITHUB_OUTPUT
            echo "tag=${{ needs.release.outputs.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ needs.tag-release.outputs.version }}" >> $GITHUB_OUTPUT
            echo "tag=${{ needs.tag-release.outputs.tag_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Trigger API deployment
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'deploy-api.yml',
                ref: 'main',
                inputs: {
                  environment: 'production'
                }
              });
              console.log('Triggered API production deployment');
            } catch (error) {
              console.log('Failed to trigger API deployment:', error.message);
            }

      - name: Trigger Web deployment
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'deploy-web.yml',
                ref: 'main',
                inputs: {
                  environment: 'production'
                }
              });
              console.log('Triggered Web production deployment');
            } catch (error) {
              console.log('Failed to trigger Web deployment:', error.message);
            }

      - name: Trigger Admin deployment
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'deploy-admin.yml',
                ref: 'main',
                inputs: {
                  environment: 'production'
                }
              });
              console.log('Triggered Admin production deployment');
            } catch (error) {
              console.log('Failed to trigger Admin deployment:', error.message);
            }

  # ===========================================================================
  # Notify Release
  # ===========================================================================
  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [release, tag-release, post-release]
    if: |
      always() &&
      (needs.release.outputs.release_created == 'true' || needs.tag-release.result == 'success')
    steps:
      - name: Get release info
        id: info
        run: |
          if [ "${{ needs.release.outputs.version }}" != "" ]; then
            echo "version=${{ needs.release.outputs.version }}" >> $GITHUB_OUTPUT
            echo "tag=${{ needs.release.outputs.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ needs.tag-release.outputs.version }}" >> $GITHUB_OUTPUT
            echo "tag=${{ needs.tag-release.outputs.tag_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Generate release summary
        run: |
          echo "# Release ${{ steps.info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.info.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | ${{ steps.info.outputs.tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Date | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployments Triggered" >> $GITHUB_STEP_SUMMARY
          echo "- API: Production" >> $GITHUB_STEP_SUMMARY
          echo "- Web: Production" >> $GITHUB_STEP_SUMMARY
          echo "- Admin: Production" >> $GITHUB_STEP_SUMMARY

      - name: Notify Slack
        if: secrets.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "New Release: ${{ steps.info.outputs.version }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\n${{ steps.info.outputs.version }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Tag:*\n${{ steps.info.outputs.tag }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Production deployments have been triggered for API, Web, and Admin."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Release"
                      },
                      "url": "https://github.com/${{ github.repository }}/releases/tag/${{ steps.info.outputs.tag }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }' \
            ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: Notify Discord
        if: secrets.DISCORD_WEBHOOK_URL != ''
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "embeds": [{
                "title": "New Release: ${{ steps.info.outputs.version }}",
                "color": 5763719,
                "fields": [
                  {"name": "Version", "value": "${{ steps.info.outputs.version }}", "inline": true},
                  {"name": "Tag", "value": "${{ steps.info.outputs.tag }}", "inline": true},
                  {"name": "Author", "value": "${{ github.actor }}", "inline": true}
                ],
                "footer": {"text": "Festival Platform Release"},
                "timestamp": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"
              }]
            }' \
            ${{ secrets.DISCORD_WEBHOOK_URL }}
        continue-on-error: true

      - name: Notify Microsoft Teams
        if: secrets.TEAMS_WEBHOOK_URL != ''
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "@type": "MessageCard",
              "@context": "http://schema.org/extensions",
              "themeColor": "0076D7",
              "summary": "New Release ${{ steps.info.outputs.version }}",
              "sections": [{
                "activityTitle": "Festival Platform - Release ${{ steps.info.outputs.version }}",
                "facts": [
                  {"name": "Version", "value": "${{ steps.info.outputs.version }}"},
                  {"name": "Tag", "value": "${{ steps.info.outputs.tag }}"},
                  {"name": "Author", "value": "${{ github.actor }}"}
                ],
                "markdown": true
              }],
              "potentialAction": [{
                "@type": "OpenUri",
                "name": "View Release",
                "targets": [{"os": "default", "uri": "https://github.com/${{ github.repository }}/releases/tag/${{ steps.info.outputs.tag }}"}]
              }]
            }' \
            ${{ secrets.TEAMS_WEBHOOK_URL }}
        continue-on-error: true
