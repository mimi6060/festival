# ============================================
# Festival Platform - Docker Compose Override (Development)
# ============================================
# Development configuration with hot-reload, volumes, and debug tools
# This file automatically extends docker-compose.yml when present

version: '3.8'

services:
  # ============================================
  # API Development Configuration
  # ============================================
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile.dev
      target: development
    environment:
      NODE_ENV: development
      DEBUG: '*'
      LOG_LEVEL: debug
      DATABASE_URL: postgresql://festival_user:festival_password@postgres:5432/festival_db?schema=public
      REDIS_URL: redis://redis:6379
      JWT_SECRET: dev-jwt-secret-not-for-production
      JWT_EXPIRES_IN: 30d
      CORS_ORIGINS: http://localhost:4200,http://localhost:4300,http://localhost:3000
    volumes:
      # Mount source code for hot-reload
      - ./apps/api/src:/app/apps/api/src:delegated
      - ./libs:/app/libs:delegated
      - ./prisma:/app/prisma:delegated
      # Exclude node_modules to use container's version
      - api_node_modules:/app/node_modules
      - api_dist:/app/dist
    command: npm run start:dev
    stdin_open: true
    tty: true

  # ============================================
  # Web Development Configuration
  # ============================================
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile.dev
      target: development
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_URL: http://localhost:3000
      NEXT_PUBLIC_APP_URL: http://localhost:4200
      WATCHPACK_POLLING: 'true'
    volumes:
      # Mount source code for hot-reload
      - ./apps/web/src:/app/apps/web/src:delegated
      - ./apps/web/public:/app/apps/web/public:delegated
      - ./libs:/app/libs:delegated
      # Exclude .next and node_modules
      - web_node_modules:/app/node_modules
      - web_next:/app/apps/web/.next
    command: npm run dev
    stdin_open: true
    tty: true

  # ============================================
  # Admin Development Configuration
  # ============================================
  admin:
    build:
      context: .
      dockerfile: festival/apps/admin/Dockerfile.dev
      target: development
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_URL: http://localhost:3000
      NEXT_PUBLIC_APP_URL: http://localhost:4300
      WATCHPACK_POLLING: 'true'
    volumes:
      # Mount source code for hot-reload
      - ./apps/admin/src:/app/apps/admin/src:delegated
      - ./apps/admin/public:/app/apps/admin/public:delegated
      - ./libs:/app/libs:delegated
      # Exclude .next and node_modules
      - admin_node_modules:/app/node_modules
      - admin_next:/app/apps/admin/.next
    command: npm run dev
    stdin_open: true
    tty: true

  # ============================================
  # Database Development Configuration
  # ============================================
  postgres:
    ports:
      - '5432:5432'
    environment:
      POSTGRES_USER: festival_user
      POSTGRES_PASSWORD: festival_password
      POSTGRES_DB: festival_db

  # ============================================
  # Redis Development Configuration
  # ============================================
  redis:
    ports:
      - '6379:6379'
    command: redis-server --appendonly yes --loglevel verbose

  # ============================================
  # MinIO Development Configuration
  # ============================================
  minio:
    ports:
      - '9000:9000'
      - '9001:9001'

  # ============================================
  # Mailhog (Always enabled in dev)
  # ============================================
  mailhog:
    profiles: []  # Override to always run in dev
    ports:
      - '1025:1025'
      - '8025:8025'

  # ============================================
  # PgAdmin for Database Management (Dev Only)
  # ============================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: festival-pgadmin
    restart: unless-stopped
    ports:
      - '5050:80'
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@festival.local
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - festival-network

  # ============================================
  # Redis Commander (Dev Only)
  # ============================================
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: festival-redis-commander
    restart: unless-stopped
    ports:
      - '8081:8081'
    environment:
      REDIS_HOSTS: local:redis:6379
    depends_on:
      - redis
    networks:
      - festival-network

# ============================================
# Development Volumes
# ============================================
volumes:
  api_node_modules:
  api_dist:
  web_node_modules:
  web_next:
  admin_node_modules:
  admin_next:
  pgadmin_data:
