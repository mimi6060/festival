# 6. Tests de Paiement

## 6.1 Tests Stripe Integration

```python
#!/usr/bin/env python3
"""
payment_test.py - Tests de securite paiement
"""
import requests
import json
import hmac
import hashlib
import time

BASE_URL = "https://staging-api.festival.io"

def get_token():
    resp = requests.post(f"{BASE_URL}/api/auth/login", json={
        "email": "user@test.festival.io",
        "password": "TestUser123!"
    })
    return resp.json().get("accessToken")

def test_price_manipulation():
    """Test de manipulation des prix"""
    token = get_token()

    print("\n=== Test Manipulation Prix ===\n")

    # Test 1: Envoyer un prix different dans la requete
    resp = requests.post(f"{BASE_URL}/api/tickets/buy",
                        headers={"Authorization": f"Bearer {token}"},
                        json={
                            "categoryId": "uuid-category",
                            "quantity": 1,
                            "price": 0.01  # Prix manipule
                        })

    if resp.status_code == 200:
        data = resp.json()
        if data.get("amount") == 0.01:
            print("[CRITIQUE] Prix manipulable cote client!")
        else:
            print("[OK] Prix calcule cote serveur")

    # Test 2: Quantite negative
    resp2 = requests.post(f"{BASE_URL}/api/tickets/buy",
                         headers={"Authorization": f"Bearer {token}"},
                         json={
                             "categoryId": "uuid-category",
                             "quantity": -5
                         })

    if resp2.status_code in [200, 201]:
        print("[CRITIQUE] Quantite negative acceptee!")
    else:
        print("[OK] Quantite negative rejetee")

def test_webhook_signature():
    """Test de verification signature webhook"""
    print("\n=== Test Webhook Signature ===\n")

    # Test 1: Webhook sans signature
    resp = requests.post(f"{BASE_URL}/api/webhooks/stripe",
                        json={"type": "payment_intent.succeeded"})

    if resp.status_code == 200:
        print("[CRITIQUE] Webhook accepte sans signature!")
    else:
        print(f"[OK] Webhook sans signature rejete ({resp.status_code})")

    # Test 2: Webhook avec fausse signature
    fake_payload = json.dumps({"type": "payment_intent.succeeded"})
    fake_signature = "fake_signature_123"

    resp2 = requests.post(f"{BASE_URL}/api/webhooks/stripe",
                         headers={"Stripe-Signature": fake_signature},
                         data=fake_payload)

    if resp2.status_code == 200:
        print("[CRITIQUE] Fausse signature acceptee!")
    else:
        print(f"[OK] Fausse signature rejetee ({resp2.status_code})")

def test_payment_status_manipulation():
    """Test de manipulation du statut de paiement"""
    token = get_token()

    print("\n=== Test Manipulation Statut Paiement ===\n")

    # Creer une intention de paiement
    resp = requests.post(f"{BASE_URL}/api/payments/create-intent",
                        headers={"Authorization": f"Bearer {token}"},
                        json={"amount": 5000, "currency": "eur"})

    if resp.status_code == 200:
        payment_id = resp.json().get("paymentId")

        # Tenter de marquer comme complete directement
        resp2 = requests.post(f"{BASE_URL}/api/payments/{payment_id}/complete",
                            headers={"Authorization": f"Bearer {token}"})

        if resp2.status_code == 200:
            print("[CRITIQUE] Statut paiement manipulable!")
        else:
            print("[OK] Statut paiement protege")

def test_currency_manipulation():
    """Test de manipulation de devise"""
    token = get_token()

    print("\n=== Test Manipulation Devise ===\n")

    # Tenter d'utiliser une devise non supportee
    resp = requests.post(f"{BASE_URL}/api/payments/create-intent",
                        headers={"Authorization": f"Bearer {token}"},
                        json={"amount": 100, "currency": "XXX"})

    if resp.status_code in [200, 201]:
        print("[WARNING] Devise inconnue acceptee")
    else:
        print("[OK] Devise validee")

    # Tenter de payer en devise differente
    resp2 = requests.post(f"{BASE_URL}/api/tickets/buy",
                         headers={"Authorization": f"Bearer {token}"},
                         json={
                             "categoryId": "uuid-category",
                             "quantity": 1,
                             "currency": "JPY"  # Devise differente pour moins payer
                         })

if __name__ == "__main__":
    test_price_manipulation()
    test_webhook_signature()
    test_payment_status_manipulation()
    test_currency_manipulation()
```

## 6.2 Tests PCI-DSS Compliance

```bash
#!/bin/bash
# pci_test.sh - Tests PCI-DSS

BASE_URL="https://staging-api.festival.io"

echo "=== Tests PCI-DSS Compliance ==="

# Test 1: Verifier que les numeros de carte ne sont pas loggues
echo -e "\n[Test] Pas de PAN dans les logs"
# Ce test necessite un acces aux logs

# Test 2: TLS 1.2 minimum
echo -e "\n[Test] TLS Version"
openssl s_client -connect staging-api.festival.io:443 -tls1 2>/dev/null | grep "Protocol"
openssl s_client -connect staging-api.festival.io:443 -tls1_1 2>/dev/null | grep "Protocol"
openssl s_client -connect staging-api.festival.io:443 -tls1_2 2>/dev/null | grep "Protocol"
openssl s_client -connect staging-api.festival.io:443 -tls1_3 2>/dev/null | grep "Protocol"

# Test 3: Pas de donnees carte dans les responses
echo -e "\n[Test] Pas de PAN dans les responses API"
TOKEN=$(curl -s -X POST "$BASE_URL/api/auth/login" \
    -H "Content-Type: application/json" \
    -d '{"email":"user@test.festival.io","password":"TestUser123!"}' \
    | jq -r '.accessToken')

# Verifier historique paiements
curl -s -X GET "$BASE_URL/api/payments/me" \
    -H "Authorization: Bearer $TOKEN" | grep -E "[0-9]{13,16}"

if [ $? -eq 0 ]; then
    echo "[CRITIQUE] Numero de carte trouve dans la reponse!"
else
    echo "[OK] Pas de PAN dans les responses"
fi

# Test 4: Headers de securite
echo -e "\n[Test] Headers de securite"
curl -s -I "$BASE_URL/api/health" | grep -E "Strict-Transport|X-Frame|X-Content|Content-Security"
```

---
