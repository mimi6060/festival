# 7. Tests Cashless/NFC

## 7.1 Tests Securite Cashless

```python
#!/usr/bin/env python3
"""
cashless_test.py - Tests securite cashless
"""
import requests
import uuid
import time
from concurrent.futures import ThreadPoolExecutor

BASE_URL = "https://staging-api.festival.io"

def get_token(email="user@test.festival.io"):
    resp = requests.post(f"{BASE_URL}/api/auth/login", json={
        "email": email,
        "password": "TestUser123!"
    })
    return resp.json().get("accessToken")

def test_balance_manipulation():
    """Test de manipulation du solde"""
    token = get_token()

    print("\n=== Test Manipulation Solde ===\n")

    # Test 1: Recharge avec montant negatif
    resp = requests.post(f"{BASE_URL}/api/cashless/topup",
                        headers={"Authorization": f"Bearer {token}"},
                        json={"amount": -100})

    if resp.status_code in [200, 201]:
        print("[CRITIQUE] Montant negatif accepte!")
    else:
        print(f"[OK] Montant negatif rejete ({resp.status_code})")

    # Test 2: Paiement superieur au solde
    balance_resp = requests.get(f"{BASE_URL}/api/cashless/balance",
                               headers={"Authorization": f"Bearer {token}"})
    current_balance = balance_resp.json().get("balance", 0)

    resp2 = requests.post(f"{BASE_URL}/api/cashless/pay",
                         headers={"Authorization": f"Bearer {token}"},
                         json={
                             "amount": current_balance + 1000,
                             "vendorId": "uuid-vendor"
                         })

    if resp2.status_code in [200, 201]:
        print("[CRITIQUE] Paiement superieur au solde accepte!")
    else:
        print("[OK] Paiement superieur au solde rejete")

def test_race_condition():
    """Test de race condition sur le solde"""
    token = get_token()

    print("\n=== Test Race Condition ===\n")

    # Obtenir le solde initial
    resp = requests.get(f"{BASE_URL}/api/cashless/balance",
                       headers={"Authorization": f"Bearer {token}"})
    initial_balance = resp.json().get("balance", 0)

    if initial_balance < 20:
        print("[SKIP] Solde insuffisant pour le test")
        return

    # Tenter plusieurs paiements simultanement
    def make_payment():
        return requests.post(f"{BASE_URL}/api/cashless/pay",
                           headers={"Authorization": f"Bearer {token}"},
                           json={
                               "amount": 10,
                               "vendorId": "uuid-vendor"
                           })

    with ThreadPoolExecutor(max_workers=10) as executor:
        futures = [executor.submit(make_payment) for _ in range(10)]
        results = [f.result() for f in futures]

    # Verifier le solde final
    resp2 = requests.get(f"{BASE_URL}/api/cashless/balance",
                        headers={"Authorization": f"Bearer {token}"})
    final_balance = resp2.json().get("balance", 0)

    success_count = sum(1 for r in results if r.status_code in [200, 201])
    expected_balance = initial_balance - (success_count * 10)

    if final_balance < 0:
        print("[CRITIQUE] Solde negatif! Race condition exploitee!")
    elif final_balance != expected_balance:
        print(f"[WARNING] Balance inconsistante: attendu {expected_balance}, obtenu {final_balance}")
    else:
        print(f"[OK] Race condition geree. {success_count} paiements reussis")

def test_double_spend():
    """Test de double depense"""
    token = get_token()

    print("\n=== Test Double Depense ===\n")

    # Creer une transaction
    resp = requests.post(f"{BASE_URL}/api/cashless/pay",
                        headers={"Authorization": f"Bearer {token}"},
                        json={
                            "amount": 5,
                            "vendorId": "uuid-vendor",
                            "idempotencyKey": "test-key-123"
                        })

    if resp.status_code in [200, 201]:
        # Rejouer la meme transaction
        resp2 = requests.post(f"{BASE_URL}/api/cashless/pay",
                            headers={"Authorization": f"Bearer {token}"},
                            json={
                                "amount": 5,
                                "vendorId": "uuid-vendor",
                                "idempotencyKey": "test-key-123"
                            })

        if resp2.status_code == 200 and resp2.json().get("id") != resp.json().get("id"):
            print("[CRITIQUE] Double depense possible!")
        else:
            print("[OK] Idempotence respectee")

def test_nfc_spoofing():
    """Test de spoofing NFC"""
    token = get_token()

    print("\n=== Test NFC Spoofing ===\n")

    # Tenter d'associer un NFC tag deja utilise
    fake_nfc = "04:AA:BB:CC:DD:EE:FF"

    resp = requests.post(f"{BASE_URL}/api/cashless/link-nfc",
                        headers={"Authorization": f"Bearer {token}"},
                        json={"nfcTag": fake_nfc})

    # Se connecter avec un autre utilisateur et tenter le meme tag
    token2 = get_token("user2@test.festival.io")

    resp2 = requests.post(f"{BASE_URL}/api/cashless/link-nfc",
                         headers={"Authorization": f"Bearer {token2}"},
                         json={"nfcTag": fake_nfc})

    if resp2.status_code in [200, 201]:
        print("[CRITIQUE] NFC tag peut etre reutilise!")
    else:
        print("[OK] NFC tag unique par compte")

if __name__ == "__main__":
    test_balance_manipulation()
    test_race_condition()
    test_double_spend()
    test_nfc_spoofing()
```

---
