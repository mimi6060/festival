# 9. Tests Infrastructure

## 9.1 Scan de Vulnerabilites

```bash
#!/bin/bash
# infra_scan.sh - Scan infrastructure

TARGET="staging-api.festival.io"

echo "=== Scan Infrastructure ==="

# Nmap - Ports ouverts
echo -e "\n[Nmap] Scan des ports"
nmap -sS -sV -O -p- --min-rate=1000 $TARGET

# Nikto - Vulnerabilites web
echo -e "\n[Nikto] Scan vulnerabilites web"
nikto -h https://$TARGET

# SSL/TLS - Configuration
echo -e "\n[SSLScan] Configuration TLS"
sslscan $TARGET

# Nuclei - Vulnerabilites connues
echo -e "\n[Nuclei] Scan CVE"
nuclei -u https://$TARGET -t cves/

# Headers de securite
echo -e "\n[Headers] Verification headers"
curl -sI https://$TARGET/api/health | grep -E "^(Strict|X-|Content-Security)"
```

## 9.2 Tests Kubernetes

```bash
#!/bin/bash
# k8s_security.sh - Tests securite Kubernetes

echo "=== Tests Securite Kubernetes ==="

# Verifier les RBAC
echo -e "\n[RBAC] Roles et bindings"
kubectl get roles,rolebindings,clusterroles,clusterrolebindings -A

# Network policies
echo -e "\n[Network] Policies"
kubectl get networkpolicies -A

# Pod Security
echo -e "\n[Pods] Security context"
kubectl get pods -A -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.securityContext}{"\n"}{end}'

# Secrets
echo -e "\n[Secrets] Liste (ne pas afficher les valeurs!)"
kubectl get secrets -A --show-labels

# Service accounts
echo -e "\n[SA] Service accounts"
kubectl get serviceaccounts -A

# Privileged containers
echo -e "\n[Privileged] Containers privilegies"
kubectl get pods -A -o jsonpath='{range .items[*]}{range .spec.containers[*]}{.name}{"\t"}{.securityContext.privileged}{"\n"}{end}{end}'
```

## 9.3 Tests Docker

```bash
#!/bin/bash
# docker_security.sh - Tests securite Docker

echo "=== Tests Securite Docker ==="

# Images - Vulnerabilites
echo -e "\n[Trivy] Scan images"
trivy image festival/api:latest

# Configuration
echo -e "\n[Docker Bench] Audit configuration"
docker run --rm --net host --pid host --userns host --cap-add audit_control \
    -e DOCKER_CONTENT_TRUST=$DOCKER_CONTENT_TRUST \
    -v /etc:/etc:ro \
    -v /var/lib:/var/lib:ro \
    -v /var/run/docker.sock:/var/run/docker.sock:ro \
    --label docker_bench_security \
    docker/docker-bench-security

# Secrets dans les images
echo -e "\n[Secrets] Recherche secrets dans images"
docker history --no-trunc festival/api:latest | grep -iE "password|secret|key|token"
```

---
