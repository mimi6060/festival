# ============================================
# Festival Platform - Docker Compose
# ============================================
# Production-ready docker-compose configuration
# Includes all services: API, Web, Admin, and infrastructure
#
# Usage:
#   Development: docker compose --profile dev up -d
#   Production:  docker compose up -d
#   Monitoring:  docker compose --profile monitoring up -d
#   All:         docker compose --profile dev --profile monitoring up -d

version: '3.8'

services:
  # ============================================
  # Application Services
  # ============================================

  # NestJS API Backend
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
      args:
        - NODE_ENV=production
    image: festival/api:${API_VERSION:-latest}
    container_name: festival-api
    hostname: festival-api
    restart: unless-stopped
    ports:
      - '${API_PORT:-3333}:3333'
    environment:
      NODE_ENV: production
      PORT: 3333
      # Database Configuration
      DATABASE_URL: postgresql://${POSTGRES_USER:-festival_user}:${POSTGRES_PASSWORD:-festival_password}@postgres:5432/${POSTGRES_DB:-festival_db}?schema=public&connection_limit=10&pool_timeout=30
      # Redis Configuration
      REDIS_URL: redis://redis:6379
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # Authentication
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-${JWT_SECRET}}
      JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:-30d}
      # CORS Configuration
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:4200,http://localhost:4300}
      # Stripe Payment Configuration
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY:-}
      # MinIO/S3 Storage Configuration
      MINIO_ENDPOINT: minio
      MINIO_PORT: 9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_BUCKET: ${MINIO_BUCKET:-festival-uploads}
      MINIO_USE_SSL: 'false'
      # SMTP Email Configuration
      SMTP_HOST: ${SMTP_HOST:-mailhog}
      SMTP_PORT: ${SMTP_PORT:-1025}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM: ${SMTP_FROM:-noreply@festival-platform.com}
      SMTP_SECURE: ${SMTP_SECURE:-false}
      # Logging & Monitoring
      LOG_LEVEL: ${LOG_LEVEL:-info}
      SENTRY_DSN: ${SENTRY_DSN:-}
      # Rate Limiting
      THROTTLE_TTL: ${THROTTLE_TTL:-60}
      THROTTLE_LIMIT: ${THROTTLE_LIMIT:-100}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - festival-network
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:3333/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: json-file
      options:
        max-size: '10m'
        max-file: '5'
        labels: 'service,environment'
    labels:
      - 'com.festival.service=api'
      - 'com.festival.description=NestJS API Backend'
      - 'traefik.enable=true'
      - 'traefik.http.routers.api.rule=Host(`api.localhost`)'
      - 'traefik.http.services.api.loadbalancer.server.port=3333'
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 512M

  # Next.js Web Frontend (Public-facing website)
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      args:
        - NODE_ENV=production
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://api:3333}
        - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_WEB_URL:-http://localhost:4200}
    image: festival/web:${WEB_VERSION:-latest}
    container_name: festival-web
    hostname: festival-web
    restart: unless-stopped
    ports:
      - '${WEB_PORT:-4200}:3000'
    environment:
      NODE_ENV: production
      PORT: 3000
      # API Configuration (runtime)
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://api:3333}
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_WEB_URL:-http://localhost:4200}
      # Stripe Configuration (client-side)
      NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY:-}
      # Feature Flags
      NEXT_PUBLIC_ENABLE_ANALYTICS: ${ENABLE_ANALYTICS:-false}
      NEXT_PUBLIC_ENABLE_CASHLESS: ${ENABLE_CASHLESS:-true}
    depends_on:
      api:
        condition: service_healthy
    networks:
      - festival-network
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:3000']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: '10m'
        max-file: '3'
    labels:
      - 'com.festival.service=web'
      - 'com.festival.description=Next.js Web Frontend'
      - 'traefik.enable=true'
      - 'traefik.http.routers.web.rule=Host(`localhost`)'
      - 'traefik.http.services.web.loadbalancer.server.port=3000'
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 256M

  # Next.js Admin Panel (Back-office for organizers)
  admin:
    build:
      context: .
      dockerfile: apps/admin/Dockerfile
      args:
        - NODE_ENV=production
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://api:3333}
        - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_ADMIN_URL:-http://localhost:4300}
    image: festival/admin:${ADMIN_VERSION:-latest}
    container_name: festival-admin
    hostname: festival-admin
    restart: unless-stopped
    ports:
      - '${ADMIN_PORT:-4300}:3000'
    environment:
      NODE_ENV: production
      PORT: 3000
      # API Configuration (runtime)
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://api:3333}
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_ADMIN_URL:-http://localhost:4300}
      # Admin-specific Configuration
      NEXT_PUBLIC_ENABLE_REALTIME: ${ENABLE_REALTIME:-true}
    depends_on:
      api:
        condition: service_healthy
    networks:
      - festival-network
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:3000']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: '10m'
        max-file: '3'
    labels:
      - 'com.festival.service=admin'
      - 'com.festival.description=Next.js Admin Panel'
      - 'traefik.enable=true'
      - 'traefik.http.routers.admin.rule=Host(`admin.localhost`)'
      - 'traefik.http.services.admin.loadbalancer.server.port=3000'
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 256M

  # ============================================
  # Infrastructure Services
  # ============================================

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: festival-postgres
    hostname: festival-postgres
    restart: unless-stopped
    ports:
      - '${POSTGRES_PORT:-5432}:5432'
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-festival_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-festival_password}
      POSTGRES_DB: ${POSTGRES_DB:-festival_db}
      PGDATA: /var/lib/postgresql/data/pgdata
      # Performance tuning for containers
      POSTGRES_INITDB_ARGS: '--encoding=UTF-8 --lc-collate=C --lc-ctype=C'
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/01-init-db.sql:ro
    networks:
      - festival-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-festival_user} -d ${POSTGRES_DB:-festival_db}']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: '20m'
        max-file: '5'
    labels:
      - 'com.festival.service=postgres'
      - 'com.festival.description=PostgreSQL Database'
    command:
      - 'postgres'
      - '-c'
      - 'max_connections=200'
      - '-c'
      - 'shared_buffers=256MB'
      - '-c'
      - 'effective_cache_size=768MB'
      - '-c'
      - 'maintenance_work_mem=128MB'
      - '-c'
      - 'checkpoint_completion_target=0.9'
      - '-c'
      - 'wal_buffers=16MB'
      - '-c'
      - 'default_statistics_target=100'
      - '-c'
      - 'random_page_cost=1.1'
      - '-c'
      - 'effective_io_concurrency=200'
      - '-c'
      - 'work_mem=4MB'
      - '-c'
      - 'min_wal_size=1GB'
      - '-c'
      - 'max_wal_size=4GB'
      - '-c'
      - 'log_statement=mod'
      - '-c'
      - 'log_min_duration_statement=1000'
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Redis Cache & Session Store
  redis:
    image: redis:7-alpine
    container_name: festival-redis
    hostname: festival-redis
    restart: unless-stopped
    ports:
      - '${REDIS_PORT:-6379}:6379'
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory ${REDIS_MAXMEMORY:-256mb}
      --maxmemory-policy allkeys-lru
      --tcp-backlog 511
      --tcp-keepalive 300
      --timeout 0
      --databases 16
      --save 900 1
      --save 300 10
      --save 60 10000
      --loglevel notice
    volumes:
      - redis_data:/data
    networks:
      - festival-network
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: '10m'
        max-file: '3'
    labels:
      - 'com.festival.service=redis'
      - 'com.festival.description=Redis Cache and Session Store'
    sysctls:
      net.core.somaxconn: '511'
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M

  # MinIO (S3-compatible Object Storage)
  minio:
    image: minio/minio:RELEASE.2024-01-01T16-36-33Z
    container_name: festival-minio
    hostname: festival-minio
    restart: unless-stopped
    ports:
      - '${MINIO_API_PORT:-9000}:9000'
      - '${MINIO_CONSOLE_PORT:-9001}:9001'
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_BROWSER_REDIRECT_URL: ${MINIO_BROWSER_REDIRECT_URL:-http://localhost:9001}
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    networks:
      - festival-network
    healthcheck:
      test: ['CMD', 'mc', 'ready', 'local']
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: '10m'
        max-file: '3'
    labels:
      - 'com.festival.service=minio'
      - 'com.festival.description=S3-compatible Object Storage'
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 256M

  # Mailhog (Email Testing - Development Only)
  mailhog:
    image: mailhog/mailhog:v1.0.1
    container_name: festival-mailhog
    hostname: festival-mailhog
    restart: unless-stopped
    ports:
      - '${MAILHOG_SMTP_PORT:-1025}:1025' # SMTP
      - '${MAILHOG_WEB_PORT:-8025}:8025'  # Web UI
    networks:
      - festival-network
    logging:
      driver: 'none'
    labels:
      - 'com.festival.service=mailhog'
      - 'com.festival.description=Email Testing Server'
    profiles:
      - dev
      - development

  # ============================================
  # Monitoring Services (Optional)
  # ============================================

  # Prometheus for metrics collection
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: festival-prometheus
    hostname: festival-prometheus
    restart: unless-stopped
    ports:
      - '${PROMETHEUS_PORT:-9090}:9090'
    user: root
    volumes:
      - ./infra/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./infra/prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - ./infra/prometheus/recording_rules.yml:/etc/prometheus/recording_rules.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--storage.tsdb.retention.size=10GB'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    networks:
      - festival-network
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:9090/-/healthy']
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: json-file
      options:
        max-size: '10m'
        max-file: '3'
    labels:
      - 'com.festival.service=prometheus'
      - 'com.festival.description=Metrics Collection'
    profiles:
      - monitoring

  # Grafana for visualization
  grafana:
    image: grafana/grafana:10.2.3
    container_name: festival-grafana
    hostname: festival-grafana
    restart: unless-stopped
    ports:
      - '${GRAFANA_PORT:-3001}:3000'
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP: 'false'
      GF_SERVER_ROOT_URL: ${GRAFANA_ROOT_URL:-http://localhost:3001}
      GF_INSTALL_PLUGINS: grafana-clock-panel,grafana-simple-json-datasource,grafana-piechart-panel
      GF_AUTH_ANONYMOUS_ENABLED: 'false'
      GF_SECURITY_DISABLE_GRAVATAR: 'true'
      GF_ANALYTICS_REPORTING_ENABLED: 'false'
    volumes:
      - grafana_data:/var/lib/grafana
      - ./infra/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./infra/grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      prometheus:
        condition: service_healthy
    networks:
      - festival-network
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:3000/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: json-file
      options:
        max-size: '10m'
        max-file: '3'
    labels:
      - 'com.festival.service=grafana'
      - 'com.festival.description=Metrics Visualization'
    profiles:
      - monitoring

  # ============================================
  # Reverse Proxy / Load Balancer (Optional)
  # ============================================

  # Traefik for routing and SSL termination
  traefik:
    image: traefik:v2.11
    container_name: festival-traefik
    hostname: festival-traefik
    restart: unless-stopped
    ports:
      - '${TRAEFIK_HTTP_PORT:-80}:80'
      - '${TRAEFIK_HTTPS_PORT:-443}:443'
      - '${TRAEFIK_DASHBOARD_PORT:-8080}:8080'
    command:
      - '--api.dashboard=true'
      - '--api.insecure=true'
      - '--providers.docker=true'
      - '--providers.docker.exposedbydefault=false'
      - '--providers.docker.network=festival-network'
      - '--entrypoints.web.address=:80'
      - '--entrypoints.websecure.address=:443'
      - '--log.level=${TRAEFIK_LOG_LEVEL:-INFO}'
      - '--accesslog=true'
      - '--metrics.prometheus=true'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - festival-network
    healthcheck:
      test: ['CMD', 'traefik', 'healthcheck', '--ping']
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: json-file
      options:
        max-size: '10m'
        max-file: '3'
    labels:
      - 'com.festival.service=traefik'
      - 'com.festival.description=Reverse Proxy and Load Balancer'
    profiles:
      - proxy
      - production

# ============================================
# Networks
# ============================================
networks:
  festival-network:
    name: festival-network
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1
    labels:
      - 'com.festival.network=main'

# ============================================
# Volumes
# ============================================
volumes:
  postgres_data:
    name: festival-postgres-data
    driver: local
    labels:
      - 'com.festival.volume=postgres'
  redis_data:
    name: festival-redis-data
    driver: local
    labels:
      - 'com.festival.volume=redis'
  minio_data:
    name: festival-minio-data
    driver: local
    labels:
      - 'com.festival.volume=minio'
  prometheus_data:
    name: festival-prometheus-data
    driver: local
    labels:
      - 'com.festival.volume=prometheus'
  grafana_data:
    name: festival-grafana-data
    driver: local
    labels:
      - 'com.festival.volume=grafana'
