# ============================================================================
# PostgreSQL Recovery Configuration
# Festival Management Platform - High Availability Setup
# ============================================================================
# This file is used for Point-in-Time Recovery (PITR) and failover scenarios
# For PostgreSQL 12+, these settings go in postgresql.conf or postgresql.auto.conf
# ============================================================================

# -----------------------------------------------------------------------------
# Standby Mode Configuration
# -----------------------------------------------------------------------------

# Enable standby mode (replica will continuously recover from primary)
standby_mode = 'on'

# Connection info to the primary server
primary_conninfo = 'host=primary port=5432 user=replicator password=REPLICATOR_PASSWORD application_name=replica1 sslmode=require sslcert=/etc/postgresql/ssl/client.crt sslkey=/etc/postgresql/ssl/client.key sslrootcert=/etc/postgresql/ssl/ca.crt'

# Use a replication slot for guaranteed WAL retention
primary_slot_name = 'replica1_slot'

# Command to restore archived WAL segments
restore_command = '/usr/local/bin/wal-restore.sh %f %p'

# Follow the latest timeline during recovery
recovery_target_timeline = 'latest'

# -----------------------------------------------------------------------------
# Point-in-Time Recovery (PITR) Options
# Uncomment and configure ONE of these options for PITR
# -----------------------------------------------------------------------------

# Recover to a specific transaction ID
# recovery_target_xid = '12345678'

# Recover to a specific timestamp
# recovery_target_time = '2024-01-15 14:30:00 UTC'

# Recover to a specific named restore point
# recovery_target_name = 'before_major_update'

# Recover to a specific LSN (Log Sequence Number)
# recovery_target_lsn = '0/1000000'

# Recover to the earliest consistent point
# recovery_target = 'immediate'

# -----------------------------------------------------------------------------
# Recovery Target Action
# -----------------------------------------------------------------------------

# What to do when recovery target is reached:
# - 'pause': Pause recovery (for inspection)
# - 'promote': Promote to primary
# - 'shutdown': Shutdown cleanly
recovery_target_action = 'pause'

# Whether to include or exclude the recovery target
# 'true' = include the target (stop just after)
# 'false' = exclude the target (stop just before)
recovery_target_inclusive = 'true'

# -----------------------------------------------------------------------------
# Archive Recovery
# -----------------------------------------------------------------------------

# Command to fetch archived WAL files from S3
# This is executed when streaming replication falls behind
restore_command = 'aws s3 cp s3://festival-wal-archive/%f %p --region eu-west-1 || /usr/local/bin/wal-restore.sh %f %p'

# Command to run when recovery ends
# recovery_end_command = '/usr/local/bin/recovery-complete.sh'

# Command to run at each checkpoint during recovery
# archive_cleanup_command = 'pg_archivecleanup /var/lib/postgresql/archive %r'

# -----------------------------------------------------------------------------
# Trigger File (Fallback Promotion)
# -----------------------------------------------------------------------------

# File that triggers promotion when created (deprecated in PG 12+)
# Use pg_ctl promote or pg_promote() function instead
# trigger_file = '/tmp/postgresql.trigger.5432'

# For PG 12+, use:
# promote_trigger_file = '/tmp/promote.trigger'

# ============================================================================
# PostgreSQL 12+ Configuration
# ============================================================================
# Starting with PostgreSQL 12, recovery.conf is deprecated.
# These settings should be placed in postgresql.conf or postgresql.auto.conf
#
# Use standby.signal file to indicate standby mode:
#   touch /var/lib/postgresql/data/standby.signal
#
# For PITR, use recovery.signal:
#   touch /var/lib/postgresql/data/recovery.signal
# ============================================================================

# ============================================================================
# Example: Full PITR Recovery Configuration (postgresql.conf)
# ============================================================================
# # For standby mode
# primary_conninfo = 'host=primary port=5432 ...'
# primary_slot_name = 'replica1_slot'
# restore_command = 'aws s3 cp s3://festival-wal-archive/%f %p'
# recovery_target_timeline = 'latest'
#
# # For PITR to specific time
# restore_command = 'aws s3 cp s3://festival-wal-archive/%f %p'
# recovery_target_time = '2024-01-15 14:30:00 UTC'
# recovery_target_action = 'pause'
# ============================================================================

# ============================================================================
# Multi-AZ Recovery Scenarios
# ============================================================================
#
# SCENARIO 1: Primary AZ failure
# 1. Detect primary failure (Patroni/HAProxy)
# 2. Promote replica in secondary AZ
# 3. Update DNS/connection strings
# 4. Create new replica in tertiary AZ
#
# SCENARIO 2: Accidental data deletion
# 1. Stop application writes
# 2. Create new instance from backup
# 3. Configure PITR to time before deletion
# 4. Recover data
# 5. Merge changes with primary
#
# SCENARIO 3: Region-wide disaster
# 1. Activate DR site
# 2. Restore from cross-region backup
# 3. PITR to latest possible point
# 4. Update global DNS
# 5. Notify users of potential data loss
# ============================================================================
