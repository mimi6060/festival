# ============================================================================
# HAProxy Configuration for PostgreSQL Cluster
# Festival Management Platform
# ============================================================================
# Load balances read traffic across replicas, routes writes to primary
# ============================================================================

global
    log stdout format raw local0
    maxconn 4096
    user haproxy
    group haproxy
    stats socket /var/run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    option  redispatch
    retries 3
    timeout connect 10s
    timeout client  30s
    timeout server  30s
    timeout check   5s
    maxconn 3000

# -----------------------------------------------------------------------------
# Stats Page
# -----------------------------------------------------------------------------
frontend stats
    mode http
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if LOCALHOST
    stats auth admin:${HAPROXY_STATS_PASSWORD:-haproxy_secret}

# -----------------------------------------------------------------------------
# PostgreSQL Write Frontend (Primary Only)
# Port 5440: Write operations -> Primary
# -----------------------------------------------------------------------------
frontend postgres_write
    bind *:5440
    mode tcp
    option tcplog
    default_backend postgres_primary

# -----------------------------------------------------------------------------
# PostgreSQL Read Frontend (Replicas with Primary Fallback)
# Port 5441: Read operations -> Replicas (load balanced)
# -----------------------------------------------------------------------------
frontend postgres_read
    bind *:5441
    mode tcp
    option tcplog
    default_backend postgres_replicas

# -----------------------------------------------------------------------------
# PostgreSQL Primary Backend
# Only the primary server for write operations
# -----------------------------------------------------------------------------
backend postgres_primary
    mode tcp
    option tcp-check
    # Health check: Only consider server available if it's the primary
    tcp-check connect
    tcp-check send-binary 000000280003000075736572006665737469766a616c5f61646d696e00646174616261736500666573746976616c0000 # PGPROTO startup
    tcp-check expect string "R" # Authentication response

    # Use pg_isready for health check
    option httpchk GET /primary
    http-check expect status 200

    # Primary server configuration
    server postgres-primary postgres-primary:5432 check port 5432 inter 3s fall 3 rise 2 weight 100

# -----------------------------------------------------------------------------
# PostgreSQL Replicas Backend
# Load balanced across all replica servers
# Falls back to primary if all replicas are down
# -----------------------------------------------------------------------------
backend postgres_replicas
    mode tcp
    balance roundrobin
    option tcp-check

    # Replica servers (preferred for reads)
    server postgres-replica1 postgres-replica1:5432 check port 5432 inter 3s fall 3 rise 2 weight 100
    server postgres-replica2 postgres-replica2:5432 check port 5432 inter 3s fall 3 rise 2 weight 100

    # Primary as backup (only used if all replicas are down)
    server postgres-primary postgres-primary:5432 check port 5432 inter 3s fall 3 rise 2 weight 50 backup

# -----------------------------------------------------------------------------
# PostgreSQL All Servers Backend (for monitoring)
# Used by monitoring tools to check all database nodes
# -----------------------------------------------------------------------------
backend postgres_all
    mode tcp
    balance roundrobin
    option tcp-check

    server postgres-primary postgres-primary:5432 check port 5432 inter 5s fall 3 rise 2
    server postgres-replica1 postgres-replica1:5432 check port 5432 inter 5s fall 3 rise 2
    server postgres-replica2 postgres-replica2:5432 check port 5432 inter 5s fall 3 rise 2

# -----------------------------------------------------------------------------
# Additional Configuration Notes
# -----------------------------------------------------------------------------
#
# Connection Strings:
#   Write: postgresql://festival_admin:pass@haproxy:5440/festival
#   Read:  postgresql://festival_readonly:pass@haproxy:5441/festival
#
# Application Configuration:
#   - Configure your ORM/connection pool to use separate connections for
#     read and write operations
#   - Example with Prisma:
#     datasources:
#       db:
#         url: env("DATABASE_URL_WRITE")
#       dbRead:
#         url: env("DATABASE_URL_READ")
#
# Monitoring:
#   - HAProxy stats: http://haproxy:8404/stats
#   - Check backend health: echo "show servers state" | socat stdio /var/run/haproxy/admin.sock
#
# Failover:
#   - HAProxy automatically routes traffic away from failed nodes
#   - If primary fails, writes will fail until manual promotion
#   - If all replicas fail, reads automatically fallback to primary
# ============================================================================
