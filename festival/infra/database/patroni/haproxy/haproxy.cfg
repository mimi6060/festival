# ============================================================================
# HAProxy Configuration for Patroni PostgreSQL Cluster
# Festival Management Platform
# ============================================================================
# Routes connections to primary for writes and replicas for reads
# ============================================================================

global
    maxconn 10000
    log stdout format raw local0 info
    stats socket /var/run/haproxy.sock mode 660 level admin expose-fd listeners
    stats timeout 30s

    # SSL/TLS settings
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-default-server-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-server-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    mode tcp
    log global
    option tcplog
    option dontlognull
    option redispatch
    option tcp-check

    timeout connect 5s
    timeout client 30m
    timeout server 30m
    timeout check 5s

    retries 3
    maxconn 5000

    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions

# -----------------------------------------------------------------------------
# Statistics Dashboard
# -----------------------------------------------------------------------------
frontend stats
    mode http
    bind *:7000
    stats enable
    stats uri /stats
    stats refresh 10s
    stats show-legends
    stats show-node
    stats auth admin:${HAPROXY_STATS_PASSWORD}

    # Health check endpoints
    monitor-uri /health

# -----------------------------------------------------------------------------
# Primary (Read-Write) Frontend
# -----------------------------------------------------------------------------
frontend postgresql_primary
    bind *:5000
    default_backend postgresql_primary_backend

    # Connection limits per IP
    stick-table type ip size 200k expire 30s store conn_cur
    tcp-request connection track-sc0 src
    tcp-request connection reject if { sc0_conn_cur ge 100 }

# -----------------------------------------------------------------------------
# Replicas (Read-Only) Frontend
# -----------------------------------------------------------------------------
frontend postgresql_replicas
    bind *:5001
    default_backend postgresql_replicas_backend

    # Connection limits per IP
    stick-table type ip size 200k expire 30s store conn_cur
    tcp-request connection track-sc0 src
    tcp-request connection reject if { sc0_conn_cur ge 200 }

# -----------------------------------------------------------------------------
# Primary Backend
# Only routes to the current Patroni leader
# -----------------------------------------------------------------------------
backend postgresql_primary_backend
    option httpchk GET /primary
    http-check expect status 200

    default-server inter 2s fall 2 rise 2 maxconn 300

    server patroni1 patroni1:5432 check port 8008
    server patroni2 patroni2:5432 check port 8008
    server patroni3 patroni3:5432 check port 8008

# -----------------------------------------------------------------------------
# Replicas Backend (Read-Only)
# Routes to all healthy replicas for read scaling
# -----------------------------------------------------------------------------
backend postgresql_replicas_backend
    option httpchk GET /replica
    http-check expect status 200

    balance roundrobin
    default-server inter 2s fall 2 rise 2 maxconn 200

    # Replicas only (primary excluded via /replica check)
    server patroni1 patroni1:5432 check port 8008
    server patroni2 patroni2:5432 check port 8008
    server patroni3 patroni3:5432 check port 8008

# -----------------------------------------------------------------------------
# Synchronous Replica Backend (Optional)
# Only routes to synchronous standbys
# -----------------------------------------------------------------------------
backend postgresql_sync_backend
    option httpchk GET /sync
    http-check expect status 200

    balance roundrobin
    default-server inter 2s fall 2 rise 2 maxconn 100

    server patroni1 patroni1:5432 check port 8008
    server patroni2 patroni2:5432 check port 8008
    server patroni3 patroni3:5432 check port 8008

# -----------------------------------------------------------------------------
# All Nodes Backend (for monitoring)
# -----------------------------------------------------------------------------
backend postgresql_all_backend
    option httpchk GET /health
    http-check expect status 200

    balance roundrobin
    default-server inter 5s fall 3 rise 2 maxconn 50

    server patroni1 patroni1:5432 check port 8008
    server patroni2 patroni2:5432 check port 8008
    server patroni3 patroni3:5432 check port 8008

# ============================================================================
# Patroni REST API Endpoints Reference
# ============================================================================
# GET /                 - Returns node state (JSON)
# GET /primary          - 200 if node is primary, 503 otherwise
# GET /leader           - Same as /primary (alias)
# GET /replica          - 200 if node is replica, 503 otherwise
# GET /sync             - 200 if node is sync standby
# GET /async            - 200 if node is async standby
# GET /health           - 200 if node is running
# GET /read-only        - 200 if primary or replica (for read queries)
# GET /read-write       - 200 if primary (for write queries)
# GET /master           - Deprecated, use /primary
# GET /standby-leader   - 200 if standby leader in standby cluster
# ============================================================================
