# ============================================================================
# Redis Cluster Docker Compose Configuration
# Festival Management Platform
# ============================================================================
# This configuration sets up a Redis Cluster with:
# - 6 nodes (3 masters + 3 replicas for HA)
# - Sentinel for automatic failover monitoring
# - HAProxy for client connection routing
# ============================================================================

version: '3.8'

services:
  # ===========================================================================
  # Redis Cluster Nodes (6 nodes for 3 shards with replication)
  # ===========================================================================

  redis-node-1:
    image: redis:7-alpine
    container_name: festival-redis-node-1
    hostname: redis-node-1
    command: >
      redis-server
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --appendfsync everysec
      --requirepass ${REDIS_PASSWORD:-redis_secret}
      --masterauth ${REDIS_PASSWORD:-redis_secret}
      --port 6379
      --bind 0.0.0.0
      --protected-mode no
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 300
      --timeout 0
      --save 900 1
      --save 300 10
      --save 60 10000
    volumes:
      - redis-node-1-data:/data
    ports:
      - "6379:6379"
      - "16379:16379"
    networks:
      redis-cluster:
        ipv4_address: 172.30.0.11
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redis_secret}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 3G
        reservations:
          cpus: '0.5'
          memory: 2G
    restart: unless-stopped
    labels:
      - "com.festival.service=cache"
      - "com.festival.role=redis-cluster-node"

  redis-node-2:
    image: redis:7-alpine
    container_name: festival-redis-node-2
    hostname: redis-node-2
    command: >
      redis-server
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --appendfsync everysec
      --requirepass ${REDIS_PASSWORD:-redis_secret}
      --masterauth ${REDIS_PASSWORD:-redis_secret}
      --port 6379
      --bind 0.0.0.0
      --protected-mode no
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis-node-2-data:/data
    ports:
      - "6380:6379"
      - "16380:16379"
    networks:
      redis-cluster:
        ipv4_address: 172.30.0.12
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redis_secret}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 3G
    restart: unless-stopped

  redis-node-3:
    image: redis:7-alpine
    container_name: festival-redis-node-3
    hostname: redis-node-3
    command: >
      redis-server
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --appendfsync everysec
      --requirepass ${REDIS_PASSWORD:-redis_secret}
      --masterauth ${REDIS_PASSWORD:-redis_secret}
      --port 6379
      --bind 0.0.0.0
      --protected-mode no
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis-node-3-data:/data
    ports:
      - "6381:6379"
      - "16381:16379"
    networks:
      redis-cluster:
        ipv4_address: 172.30.0.13
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redis_secret}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 3G
    restart: unless-stopped

  redis-node-4:
    image: redis:7-alpine
    container_name: festival-redis-node-4
    hostname: redis-node-4
    command: >
      redis-server
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --appendfsync everysec
      --requirepass ${REDIS_PASSWORD:-redis_secret}
      --masterauth ${REDIS_PASSWORD:-redis_secret}
      --port 6379
      --bind 0.0.0.0
      --protected-mode no
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis-node-4-data:/data
    ports:
      - "6382:6379"
      - "16382:16379"
    networks:
      redis-cluster:
        ipv4_address: 172.30.0.14
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redis_secret}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 3G
    restart: unless-stopped

  redis-node-5:
    image: redis:7-alpine
    container_name: festival-redis-node-5
    hostname: redis-node-5
    command: >
      redis-server
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --appendfsync everysec
      --requirepass ${REDIS_PASSWORD:-redis_secret}
      --masterauth ${REDIS_PASSWORD:-redis_secret}
      --port 6379
      --bind 0.0.0.0
      --protected-mode no
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis-node-5-data:/data
    ports:
      - "6383:6379"
      - "16383:16379"
    networks:
      redis-cluster:
        ipv4_address: 172.30.0.15
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redis_secret}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 3G
    restart: unless-stopped

  redis-node-6:
    image: redis:7-alpine
    container_name: festival-redis-node-6
    hostname: redis-node-6
    command: >
      redis-server
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --appendfsync everysec
      --requirepass ${REDIS_PASSWORD:-redis_secret}
      --masterauth ${REDIS_PASSWORD:-redis_secret}
      --port 6379
      --bind 0.0.0.0
      --protected-mode no
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis-node-6-data:/data
    ports:
      - "6384:6379"
      - "16384:16379"
    networks:
      redis-cluster:
        ipv4_address: 172.30.0.16
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redis_secret}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 3G
    restart: unless-stopped

  # ===========================================================================
  # Redis Cluster Initializer
  # ===========================================================================
  redis-cluster-init:
    image: redis:7-alpine
    container_name: festival-redis-cluster-init
    depends_on:
      redis-node-1:
        condition: service_healthy
      redis-node-2:
        condition: service_healthy
      redis-node-3:
        condition: service_healthy
      redis-node-4:
        condition: service_healthy
      redis-node-5:
        condition: service_healthy
      redis-node-6:
        condition: service_healthy
    command: >
      sh -c "
        echo 'Waiting for Redis nodes to be ready...'
        sleep 5

        echo 'Creating Redis Cluster...'
        redis-cli -a ${REDIS_PASSWORD:-redis_secret} --cluster create \
          172.30.0.11:6379 \
          172.30.0.12:6379 \
          172.30.0.13:6379 \
          172.30.0.14:6379 \
          172.30.0.15:6379 \
          172.30.0.16:6379 \
          --cluster-replicas 1 \
          --cluster-yes

        echo 'Redis Cluster created successfully!'
        echo 'Cluster info:'
        redis-cli -a ${REDIS_PASSWORD:-redis_secret} -h 172.30.0.11 -p 6379 cluster info
        echo 'Cluster nodes:'
        redis-cli -a ${REDIS_PASSWORD:-redis_secret} -h 172.30.0.11 -p 6379 cluster nodes
      "
    networks:
      - redis-cluster
    restart: "no"

  # ===========================================================================
  # Redis Exporter for Prometheus
  # ===========================================================================
  redis-exporter:
    image: oliver006/redis_exporter:v1.55.0
    container_name: festival-redis-exporter
    hostname: redis-exporter
    environment:
      REDIS_ADDR: "redis://172.30.0.11:6379,redis://172.30.0.12:6379,redis://172.30.0.13:6379"
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis_secret}
      REDIS_EXPORTER_IS_CLUSTER: "true"
    ports:
      - "9121:9121"
    networks:
      - redis-cluster
    depends_on:
      - redis-node-1
      - redis-node-2
      - redis-node-3
    restart: unless-stopped
    labels:
      - "com.festival.service=cache"
      - "com.festival.role=exporter"

  # ===========================================================================
  # Redis Commander (Web UI for monitoring)
  # ===========================================================================
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: festival-redis-commander
    hostname: redis-commander
    environment:
      REDIS_HOSTS: >
        node1:172.30.0.11:6379:0:${REDIS_PASSWORD:-redis_secret},
        node2:172.30.0.12:6379:0:${REDIS_PASSWORD:-redis_secret},
        node3:172.30.0.13:6379:0:${REDIS_PASSWORD:-redis_secret}
      HTTP_USER: admin
      HTTP_PASSWORD: ${REDIS_COMMANDER_PASSWORD:-admin_secret}
    ports:
      - "8081:8081"
    networks:
      - redis-cluster
    depends_on:
      - redis-node-1
    restart: unless-stopped
    profiles:
      - tools

# =============================================================================
# Networks
# =============================================================================
networks:
  redis-cluster:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/24

# =============================================================================
# Volumes
# =============================================================================
volumes:
  redis-node-1-data:
    driver: local
  redis-node-2-data:
    driver: local
  redis-node-3-data:
    driver: local
  redis-node-4-data:
    driver: local
  redis-node-5-data:
    driver: local
  redis-node-6-data:
    driver: local
