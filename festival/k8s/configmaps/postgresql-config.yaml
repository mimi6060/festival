apiVersion: v1
kind: ConfigMap
metadata:
  name: postgresql-config
  namespace: festival
  labels:
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: festival-platform
data:
  # PostgreSQL Configuration
  POSTGRES_DB: "festival"
  PGDATA: "/var/lib/postgresql/data/pgdata"

  # postgresql.conf overrides
  postgresql.conf: |
    # Connection Settings
    listen_addresses = '*'
    max_connections = 200
    superuser_reserved_connections = 3

    # Memory Settings
    shared_buffers = 1GB
    effective_cache_size = 3GB
    maintenance_work_mem = 256MB
    work_mem = 16MB

    # Write Ahead Log
    wal_level = replica
    max_wal_senders = 3
    wal_keep_size = 1GB
    archive_mode = on
    archive_command = 'cp %p /var/lib/postgresql/archive/%f'

    # Query Tuning
    random_page_cost = 1.1
    effective_io_concurrency = 200

    # Logging
    log_destination = 'stderr'
    logging_collector = on
    log_directory = 'pg_log'
    log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
    log_rotation_age = 1d
    log_rotation_size = 100MB
    log_min_duration_statement = 1000
    log_checkpoints = on
    log_connections = on
    log_disconnections = on
    log_lock_waits = on

    # Autovacuum
    autovacuum = on
    autovacuum_max_workers = 3
    autovacuum_naptime = 1min

    # Replication
    hot_standby = on

  # pg_hba.conf
  pg_hba.conf: |
    # TYPE  DATABASE        USER            ADDRESS                 METHOD
    local   all             all                                     trust
    host    all             all             127.0.0.1/32            scram-sha-256
    host    all             all             ::1/128                 scram-sha-256
    host    all             all             10.0.0.0/8              scram-sha-256
    host    replication     replicator      10.0.0.0/8              scram-sha-256
