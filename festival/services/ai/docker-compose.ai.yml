# Festival AI Service - Docker Compose
# For local development and testing

version: '3.9'

services:
  # ==========================================================================
  # AI Service
  # ==========================================================================
  ai-service:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: festival-ai-service
    restart: unless-stopped
    ports:
      - "${AI_PORT:-8000}:8000"
    environment:
      # Application
      - APP_NAME=festival-ai-service
      - APP_ENV=${APP_ENV:-development}
      - DEBUG=${DEBUG:-true}
      - LOG_LEVEL=${LOG_LEVEL:-DEBUG}

      # Database
      - DATABASE_URL=postgresql+asyncpg://${DB_USER:-festival}:${DB_PASSWORD:-festival123}@postgres:5432/${DB_NAME:-festival}
      - DATABASE_POOL_SIZE=${DATABASE_POOL_SIZE:-5}
      - DATABASE_MAX_OVERFLOW=${DATABASE_MAX_OVERFLOW:-10}

      # Redis
      - REDIS_URL=redis://redis:6379/1
      - REDIS_CACHE_TTL=${REDIS_CACHE_TTL:-3600}

      # JWT (shared with NestJS backend)
      - JWT_SECRET=${JWT_SECRET:-your-super-secret-jwt-key-min-32-chars}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-3600}

      # MLflow
      - MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI:-http://mlflow:5000}
      - MLFLOW_EXPERIMENT_NAME=${MLFLOW_EXPERIMENT_NAME:-festival-ml}

      # API
      - API_PREFIX=/api/v1
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000,http://localhost:3001,http://localhost:4200}

      # Models
      - MODELS_PATH=/app/models
      - AUTO_LOAD_MODELS=${AUTO_LOAD_MODELS:-true}
    volumes:
      # Hot reload for development
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
      # Persistent storage
      - ai-models:/app/models
      - ai-logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - festival-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ==========================================================================
  # PostgreSQL Database (shared with main API)
  # ==========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: festival-postgres
    restart: unless-stopped
    ports:
      - "${DB_PORT:-5432}:5432"
    environment:
      - POSTGRES_USER=${DB_USER:-festival}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-festival123}
      - POSTGRES_DB=${DB_NAME:-festival}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - festival-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-festival} -d ${DB_NAME:-festival}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # Redis Cache (shared with main API)
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: festival-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - festival-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # MLflow Tracking Server
  # ==========================================================================
  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.10.0
    container_name: festival-mlflow
    restart: unless-stopped
    ports:
      - "${MLFLOW_PORT:-5000}:5000"
    environment:
      - MLFLOW_BACKEND_STORE_URI=postgresql://${DB_USER:-festival}:${DB_PASSWORD:-festival123}@postgres:5432/mlflow
      - MLFLOW_DEFAULT_ARTIFACT_ROOT=/mlflow/artifacts
    command: >
      mlflow server
      --host 0.0.0.0
      --port 5000
      --backend-store-uri postgresql://${DB_USER:-festival}:${DB_PASSWORD:-festival123}@postgres:5432/mlflow
      --default-artifact-root /mlflow/artifacts
    volumes:
      - mlflow-artifacts:/mlflow/artifacts
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - festival-network

  # ==========================================================================
  # Prometheus (metrics collection)
  # ==========================================================================
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: festival-prometheus
    restart: unless-stopped
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    networks:
      - festival-network

# ==========================================================================
# Networks
# ==========================================================================
networks:
  festival-network:
    driver: bridge
    name: festival-network

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  postgres-data:
    name: festival-postgres-data
  redis-data:
    name: festival-redis-data
  ai-models:
    name: festival-ai-models
  ai-logs:
    name: festival-ai-logs
  mlflow-artifacts:
    name: festival-mlflow-artifacts
  prometheus-data:
    name: festival-prometheus-data
