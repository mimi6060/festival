# ============================================================================
# PostgreSQL Host-Based Authentication Configuration
# Festival Management Platform - High Availability Setup
# ============================================================================
# TYPE  DATABASE        USER            ADDRESS                 METHOD
# ============================================================================

# -----------------------------------------------------------------------------
# Local Connections
# -----------------------------------------------------------------------------

# Local socket connections for postgres superuser (peer auth)
local   all             postgres                                peer

# Local socket connections for application
local   all             festival_app                            scram-sha-256
local   all             festival_readonly                       scram-sha-256

# Local connections via TCP/IP (localhost)
host    all             all             127.0.0.1/32            scram-sha-256
host    all             all             ::1/128                 scram-sha-256

# -----------------------------------------------------------------------------
# Replication Connections
# -----------------------------------------------------------------------------

# Replication connections from replicas (streaming replication)
# Primary to replicas - use specific IPs in production
hostssl replication     replicator      10.0.0.0/8              scram-sha-256
hostssl replication     replicator      172.16.0.0/12           scram-sha-256
hostssl replication     replicator      192.168.0.0/16          scram-sha-256

# Specific replica IPs (uncomment and configure for production)
# hostssl replication   replicator      10.0.1.10/32            scram-sha-256
# hostssl replication   replicator      10.0.1.11/32            scram-sha-256
# hostssl replication   replicator      10.0.2.10/32            scram-sha-256

# -----------------------------------------------------------------------------
# Application Connections (Private Network)
# -----------------------------------------------------------------------------

# Application servers (internal network)
hostssl festival        festival_app    10.0.0.0/8              scram-sha-256
hostssl festival        festival_app    172.16.0.0/12           scram-sha-256
hostssl festival        festival_app    192.168.0.0/16          scram-sha-256

# Read-only connections (analytics, reporting)
hostssl festival        festival_readonly   10.0.0.0/8          scram-sha-256
hostssl festival        festival_readonly   172.16.0.0/12       scram-sha-256
hostssl festival        festival_readonly   192.168.0.0/16      scram-sha-256

# Admin connections (restricted)
hostssl all             festival_admin  10.0.0.0/8              scram-sha-256
hostssl all             festival_admin  172.16.0.0/12           scram-sha-256

# -----------------------------------------------------------------------------
# PgBouncer Connections
# -----------------------------------------------------------------------------

# PgBouncer connection pooler
hostssl festival        pgbouncer       10.0.0.0/8              scram-sha-256
hostssl festival        pgbouncer       172.16.0.0/12           scram-sha-256

# -----------------------------------------------------------------------------
# Monitoring Connections
# -----------------------------------------------------------------------------

# Prometheus PostgreSQL exporter
hostssl postgres        monitoring      10.0.0.0/8              scram-sha-256
hostssl postgres        monitoring      172.16.0.0/12           scram-sha-256

# Patroni health checks
hostssl postgres        patroni         10.0.0.0/8              scram-sha-256
hostssl postgres        patroni         172.16.0.0/12           scram-sha-256

# -----------------------------------------------------------------------------
# Backup Connections
# -----------------------------------------------------------------------------

# Backup service (for pg_basebackup, pgBackRest)
hostssl all             backup          10.0.0.0/8              scram-sha-256
hostssl replication     backup          10.0.0.0/8              scram-sha-256

# -----------------------------------------------------------------------------
# Kubernetes Pod Network (if using K8s)
# -----------------------------------------------------------------------------

# Kubernetes cluster CIDR (adjust based on your cluster)
hostssl festival        festival_app    10.244.0.0/16           scram-sha-256
hostssl festival        festival_readonly 10.244.0.0/16         scram-sha-256
hostssl replication     replicator      10.244.0.0/16           scram-sha-256

# -----------------------------------------------------------------------------
# AWS VPC (if using AWS)
# -----------------------------------------------------------------------------

# AWS VPC CIDR (adjust based on your VPC)
# hostssl festival      festival_app    10.0.0.0/16             scram-sha-256
# hostssl replication   replicator      10.0.0.0/16             scram-sha-256

# -----------------------------------------------------------------------------
# Multi-AZ / Cross-Region Replication
# -----------------------------------------------------------------------------

# Cross-region replica in another AZ (specific IPs)
# hostssl replication   replicator      52.0.0.0/8              scram-sha-256 # US-East
# hostssl replication   replicator      54.0.0.0/8              scram-sha-256 # EU-West

# -----------------------------------------------------------------------------
# DENY ALL - Default deny rule (must be last)
# -----------------------------------------------------------------------------

# Reject all other connections
host    all             all             0.0.0.0/0               reject
host    all             all             ::/0                    reject

# ============================================================================
# SECURITY NOTES
# ============================================================================
# 1. Always use SSL (hostssl) for production connections
# 2. Use scram-sha-256 for password authentication (most secure)
# 3. Never use 'trust' or 'md5' in production
# 4. Restrict IP ranges as much as possible
# 5. Use separate users for different purposes (app, readonly, admin, backup)
# 6. Regularly audit and rotate passwords
# 7. Monitor failed authentication attempts
# ============================================================================
