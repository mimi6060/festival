# ============================================================================
# PostgreSQL Replica Server Configuration
# Festival Management Platform - High Availability Setup
# ============================================================================
# Optimized for read-heavy workloads
# Server specs assumption: 16GB RAM, 4 CPU cores, NVMe SSD
# ============================================================================

# -----------------------------------------------------------------------------
# Connection Settings
# -----------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
max_connections = 500
superuser_reserved_connections = 5

# -----------------------------------------------------------------------------
# Memory Configuration
# For 16GB RAM server (read replica typically smaller than primary)
# -----------------------------------------------------------------------------
shared_buffers = 4GB                    # 25% of RAM
effective_cache_size = 12GB             # 75% of RAM
work_mem = 32MB                         # For complex read queries
maintenance_work_mem = 1GB              # For occasional maintenance
wal_buffers = 128MB
huge_pages = try

# -----------------------------------------------------------------------------
# Query Planner (Optimized for read queries)
# -----------------------------------------------------------------------------
random_page_cost = 1.1
effective_io_concurrency = 200
default_statistics_target = 100
cpu_tuple_cost = 0.03
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025

# -----------------------------------------------------------------------------
# Hot Standby Configuration
# -----------------------------------------------------------------------------
hot_standby = on
hot_standby_feedback = on               # Prevent query conflicts with replication
max_standby_streaming_delay = 30s       # Max delay before canceling queries
max_standby_archive_delay = 300s        # For WAL archive recovery

# Conflict handling
wal_receiver_status_interval = 10s
wal_receiver_timeout = 60s

# -----------------------------------------------------------------------------
# WAL Receiver Settings
# -----------------------------------------------------------------------------
primary_conninfo = 'host=primary port=5432 user=replicator password=REPLICATOR_PASSWORD application_name=replica1 sslmode=require'
primary_slot_name = 'replica1_slot'
recovery_target_timeline = 'latest'

# For cascading replication (if this replica should serve as source for others)
max_wal_senders = 5
wal_keep_size = 1GB
max_replication_slots = 5

# -----------------------------------------------------------------------------
# Checkpoints (lower values since no writes)
# -----------------------------------------------------------------------------
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9
max_wal_size = 2GB
min_wal_size = 512MB

# -----------------------------------------------------------------------------
# Background Writer
# -----------------------------------------------------------------------------
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0

# -----------------------------------------------------------------------------
# Autovacuum (mainly for statistics and hint bits)
# -----------------------------------------------------------------------------
autovacuum = on
autovacuum_max_workers = 2
autovacuum_naptime = 60s
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.05
autovacuum_vacuum_cost_delay = 10ms
autovacuum_vacuum_cost_limit = 500

# -----------------------------------------------------------------------------
# Logging
# -----------------------------------------------------------------------------
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 500
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_statement = 'none'                  # Less logging on replica
log_temp_files = 0
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_timezone = 'UTC'

# -----------------------------------------------------------------------------
# Query Performance Monitoring
# -----------------------------------------------------------------------------
shared_preload_libraries = 'pg_stat_statements,auto_explain'

pg_stat_statements.max = 5000
pg_stat_statements.track = all
pg_stat_statements.track_utility = on
pg_stat_statements.save = on

auto_explain.log_min_duration = 2000    # Higher threshold on replica
auto_explain.log_analyze = on

# -----------------------------------------------------------------------------
# Statement Behavior
# -----------------------------------------------------------------------------
statement_timeout = 120000              # 2 minutes for read queries
lock_timeout = 10000                    # 10 seconds
idle_in_transaction_session_timeout = 60000  # 1 minute

# -----------------------------------------------------------------------------
# Security
# -----------------------------------------------------------------------------
ssl = on
ssl_cert_file = '/etc/postgresql/ssl/server.crt'
ssl_key_file = '/etc/postgresql/ssl/server.key'
ssl_ca_file = '/etc/postgresql/ssl/ca.crt'
ssl_prefer_server_ciphers = on
ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'
ssl_min_protocol_version = 'TLSv1.2'
password_encryption = scram-sha-256

# -----------------------------------------------------------------------------
# Client Connection Defaults
# -----------------------------------------------------------------------------
timezone = 'UTC'
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'
default_text_search_config = 'pg_catalog.english'

# -----------------------------------------------------------------------------
# Resource Usage
# -----------------------------------------------------------------------------
max_worker_processes = 4
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_parallel_maintenance_workers = 2
