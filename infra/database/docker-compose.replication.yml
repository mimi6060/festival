# ============================================================================
# PostgreSQL Master/Replica Docker Compose Configuration
# Festival Management Platform
# ============================================================================
# This configuration sets up a PostgreSQL cluster with:
# - 1 Primary (read-write)
# - 2 Replicas (read-only, streaming replication)
# - HAProxy for connection pooling and load balancing
# - PgBouncer for connection pooling on each node
# ============================================================================

version: '3.8'

services:
  # ===========================================================================
  # PostgreSQL Primary (Master)
  # ===========================================================================
  postgres-primary:
    image: postgres:16-alpine
    container_name: festival-postgres-primary
    hostname: postgres-primary
    environment:
      POSTGRES_DB: festival
      POSTGRES_USER: festival_admin
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
      # Replication user credentials
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: ${REPLICATOR_PASSWORD}
    volumes:
      - postgres-primary-data:/var/lib/postgresql/data
      - ./config/primary.conf:/etc/postgresql/postgresql.conf:ro
      - ./config/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
      - ./scripts/init-primary.sh:/docker-entrypoint-initdb.d/init-primary.sh:ro
      - ./ssl:/etc/postgresql/ssl:ro
      - postgres-primary-archive:/var/lib/postgresql/archive
    command: >
      postgres
      -c config_file=/etc/postgresql/postgresql.conf
      -c hba_file=/etc/postgresql/pg_hba.conf
    ports:
      - "5432:5432"
    networks:
      festival-db:
        aliases:
          - primary
          - db-write
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U festival_admin -d festival"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
    restart: unless-stopped
    labels:
      - "com.festival.service=database"
      - "com.festival.role=primary"
      - "com.festival.component=postgresql"

  # ===========================================================================
  # PostgreSQL Replica 1 (Hot Standby)
  # ===========================================================================
  postgres-replica1:
    image: postgres:16-alpine
    container_name: festival-postgres-replica1
    hostname: postgres-replica1
    environment:
      PGDATA: /var/lib/postgresql/data/pgdata
      PRIMARY_HOST: postgres-primary
      REPLICA_NAME: replica1
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      REPLICATOR_PASSWORD: ${REPLICATOR_PASSWORD}
    volumes:
      - postgres-replica1-data:/var/lib/postgresql/data
      - ./config/replica.conf:/etc/postgresql/postgresql.conf:ro
      - ./config/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
      - ./scripts/init-replica.sh:/docker-entrypoint-initdb.d/init-replica.sh:ro
      - ./ssl:/etc/postgresql/ssl:ro
    command: >
      postgres
      -c config_file=/etc/postgresql/postgresql.conf
      -c hba_file=/etc/postgresql/pg_hba.conf
    ports:
      - "5433:5432"
    networks:
      festival-db:
        aliases:
          - replica1
          - db-read
    depends_on:
      postgres-primary:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U festival_admin -d festival"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    restart: unless-stopped
    labels:
      - "com.festival.service=database"
      - "com.festival.role=replica"
      - "com.festival.component=postgresql"

  # ===========================================================================
  # PostgreSQL Replica 2 (Hot Standby)
  # ===========================================================================
  postgres-replica2:
    image: postgres:16-alpine
    container_name: festival-postgres-replica2
    hostname: postgres-replica2
    environment:
      PGDATA: /var/lib/postgresql/data/pgdata
      PRIMARY_HOST: postgres-primary
      REPLICA_NAME: replica2
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      REPLICATOR_PASSWORD: ${REPLICATOR_PASSWORD}
    volumes:
      - postgres-replica2-data:/var/lib/postgresql/data
      - ./config/replica.conf:/etc/postgresql/postgresql.conf:ro
      - ./config/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
      - ./scripts/init-replica.sh:/docker-entrypoint-initdb.d/init-replica.sh:ro
      - ./ssl:/etc/postgresql/ssl:ro
    command: >
      postgres
      -c config_file=/etc/postgresql/postgresql.conf
      -c hba_file=/etc/postgresql/pg_hba.conf
    ports:
      - "5434:5432"
    networks:
      festival-db:
        aliases:
          - replica2
          - db-read
    depends_on:
      postgres-primary:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U festival_admin -d festival"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    restart: unless-stopped
    labels:
      - "com.festival.service=database"
      - "com.festival.role=replica"
      - "com.festival.component=postgresql"

  # ===========================================================================
  # HAProxy Load Balancer for PostgreSQL
  # ===========================================================================
  haproxy:
    image: haproxy:2.8-alpine
    container_name: festival-haproxy-db
    hostname: haproxy-db
    volumes:
      - ./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    ports:
      # Write endpoint (primary only)
      - "5440:5440"
      # Read endpoint (replicas with fallback to primary)
      - "5441:5441"
      # HAProxy stats
      - "8404:8404"
    networks:
      - festival-db
    depends_on:
      - postgres-primary
      - postgres-replica1
      - postgres-replica2
    healthcheck:
      test: ["CMD", "haproxy", "-c", "-f", "/usr/local/etc/haproxy/haproxy.cfg"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    labels:
      - "com.festival.service=database"
      - "com.festival.role=loadbalancer"
      - "com.festival.component=haproxy"

  # ===========================================================================
  # PgBouncer Connection Pooler
  # ===========================================================================
  pgbouncer:
    image: edoburu/pgbouncer:1.21.0
    container_name: festival-pgbouncer
    hostname: pgbouncer
    environment:
      DATABASE_URL: postgresql://festival_admin:${POSTGRES_PASSWORD}@haproxy:5440/festival
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 1000
      DEFAULT_POOL_SIZE: 50
      MIN_POOL_SIZE: 10
      RESERVE_POOL_SIZE: 25
      RESERVE_POOL_TIMEOUT: 5
      MAX_DB_CONNECTIONS: 200
      MAX_USER_CONNECTIONS: 200
      SERVER_RESET_QUERY: DISCARD ALL
      SERVER_CHECK_QUERY: SELECT 1
      SERVER_CHECK_DELAY: 30
      LOG_CONNECTIONS: 1
      LOG_DISCONNECTIONS: 1
      LOG_POOLER_ERRORS: 1
      STATS_PERIOD: 60
      AUTH_TYPE: scram-sha-256
    ports:
      - "6432:6432"
    networks:
      - festival-db
    depends_on:
      - haproxy
    healthcheck:
      test: ["CMD", "psql", "-h", "localhost", "-p", "6432", "-U", "festival_admin", "-d", "pgbouncer", "-c", "SHOW STATS;"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    labels:
      - "com.festival.service=database"
      - "com.festival.role=pooler"
      - "com.festival.component=pgbouncer"

  # ===========================================================================
  # PostgreSQL Exporter for Prometheus
  # ===========================================================================
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:v0.15.0
    container_name: festival-postgres-exporter
    hostname: postgres-exporter
    environment:
      DATA_SOURCE_URI: "haproxy:5440/festival?sslmode=disable"
      DATA_SOURCE_USER: festival_admin
      DATA_SOURCE_PASS: ${POSTGRES_PASSWORD}
      PG_EXPORTER_EXTEND_QUERY_PATH: /etc/postgres_exporter/queries.yaml
    volumes:
      - ./monitoring/queries.yaml:/etc/postgres_exporter/queries.yaml:ro
    ports:
      - "9187:9187"
    networks:
      - festival-db
    depends_on:
      - haproxy
    restart: unless-stopped
    labels:
      - "com.festival.service=database"
      - "com.festival.role=exporter"
      - "com.festival.component=prometheus"

  # ===========================================================================
  # pgBackRest Backup Server
  # ===========================================================================
  pgbackrest:
    image: pgbackrest/pgbackrest:latest
    container_name: festival-pgbackrest
    hostname: pgbackrest
    environment:
      PGBACKREST_STANZA: festival
      PGBACKREST_REPO1_PATH: /var/lib/pgbackrest
      PGBACKREST_REPO1_RETENTION_FULL: 4
      PGBACKREST_REPO1_RETENTION_DIFF: 7
      PGBACKREST_LOG_LEVEL_CONSOLE: info
      PGBACKREST_PG1_HOST: postgres-primary
      PGBACKREST_PG1_PORT: 5432
      PGBACKREST_PG1_PATH: /var/lib/postgresql/data/pgdata
    volumes:
      - pgbackrest-data:/var/lib/pgbackrest
      - ./pgbackrest/pgbackrest.conf:/etc/pgbackrest/pgbackrest.conf:ro
    networks:
      - festival-db
    depends_on:
      postgres-primary:
        condition: service_healthy
    restart: unless-stopped
    labels:
      - "com.festival.service=database"
      - "com.festival.role=backup"
      - "com.festival.component=pgbackrest"

# =============================================================================
# Networks
# =============================================================================
networks:
  festival-db:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres-primary-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/festival/postgres/primary

  postgres-replica1-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/festival/postgres/replica1

  postgres-replica2-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/festival/postgres/replica2

  postgres-primary-archive:
    driver: local

  pgbackrest-data:
    driver: local
