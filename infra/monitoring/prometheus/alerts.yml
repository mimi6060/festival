# Festival Platform - Prometheus Alert Rules
# Comprehensive alerting for production monitoring

groups:
  # ==================== INFRASTRUCTURE ALERTS ====================
  - name: infrastructure
    interval: 30s
    rules:
      # Instance availability
      - alert: InstanceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
          category: infrastructure
        annotations:
          summary: "Instance {{ $labels.instance }} is down"
          description: "{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 1 minute."
          runbook_url: "https://docs.festival.app/runbooks/instance-down"

      # High memory usage
      - alert: HighMemoryUsage
        expr: (process_memory_rss_bytes / 1024 / 1024) > 1024
        for: 5m
        labels:
          severity: warning
          category: infrastructure
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage is above 1GB (current: {{ $value | printf \"%.0f\" }}MB)"

      - alert: CriticalMemoryUsage
        expr: (process_memory_rss_bytes / 1024 / 1024) > 2048
        for: 2m
        labels:
          severity: critical
          category: infrastructure
        annotations:
          summary: "Critical memory usage on {{ $labels.instance }}"
          description: "Memory usage is above 2GB (current: {{ $value | printf \"%.0f\" }}MB). Immediate action required."

      # Process uptime (detect restarts)
      - alert: ServiceRestarted
        expr: process_uptime_seconds < 300
        for: 0s
        labels:
          severity: warning
          category: infrastructure
        annotations:
          summary: "Service recently restarted on {{ $labels.instance }}"
          description: "Service uptime is less than 5 minutes. May indicate instability."

  # ==================== HTTP/API ALERTS ====================
  - name: http
    interval: 30s
    rules:
      # High error rate
      - alert: HighHttpErrorRate
        expr: |
          (
            sum(rate(http_errors_total[5m])) /
            sum(rate(http_requests_total[5m]))
          ) * 100 > 5
        for: 2m
        labels:
          severity: warning
          category: api
        annotations:
          summary: "High HTTP error rate"
          description: "HTTP error rate is {{ $value | printf \"%.2f\" }}% (threshold: 5%)"

      - alert: CriticalHttpErrorRate
        expr: |
          (
            sum(rate(http_errors_total[5m])) /
            sum(rate(http_requests_total[5m]))
          ) * 100 > 15
        for: 1m
        labels:
          severity: critical
          category: api
        annotations:
          summary: "Critical HTTP error rate"
          description: "HTTP error rate is {{ $value | printf \"%.2f\" }}% (threshold: 15%). Service may be degraded."

      # High latency
      - alert: HighApiLatency
        expr: |
          histogram_quantile(0.95, sum(rate(http_request_duration_ms_bucket[5m])) by (le)) > 500
        for: 5m
        labels:
          severity: warning
          category: api
        annotations:
          summary: "High API latency (p95)"
          description: "95th percentile latency is {{ $value | printf \"%.0f\" }}ms (threshold: 500ms)"

      - alert: CriticalApiLatency
        expr: |
          histogram_quantile(0.99, sum(rate(http_request_duration_ms_bucket[5m])) by (le)) > 2000
        for: 2m
        labels:
          severity: critical
          category: api
        annotations:
          summary: "Critical API latency (p99)"
          description: "99th percentile latency is {{ $value | printf \"%.0f\" }}ms (threshold: 2000ms)"

      # Request rate anomaly (traffic spike or drop)
      - alert: TrafficSpike
        expr: |
          sum(rate(http_requests_total[5m])) >
          (sum(rate(http_requests_total[1h])) * 3)
        for: 5m
        labels:
          severity: warning
          category: api
        annotations:
          summary: "Unusual traffic spike detected"
          description: "Request rate is 3x higher than the 1-hour average. May indicate attack or viral event."

      - alert: TrafficDrop
        expr: |
          sum(rate(http_requests_total[5m])) <
          (sum(rate(http_requests_total[1h])) * 0.1)
        for: 10m
        labels:
          severity: warning
          category: api
        annotations:
          summary: "Unusual traffic drop detected"
          description: "Request rate dropped to less than 10% of the 1-hour average."

  # ==================== DATABASE ALERTS ====================
  - name: database
    interval: 30s
    rules:
      # Database errors
      - alert: DatabaseErrors
        expr: sum(rate(db_errors_total[5m])) > 0.1
        for: 2m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "Database errors detected"
          description: "Database error rate is {{ $value | printf \"%.2f\" }} errors/sec"

      - alert: CriticalDatabaseErrors
        expr: sum(rate(db_errors_total[5m])) > 1
        for: 1m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "Critical database errors"
          description: "Database error rate is {{ $value | printf \"%.2f\" }} errors/sec. Database may be unavailable."

      # Slow queries
      - alert: SlowDatabaseQueries
        expr: |
          histogram_quantile(0.95, sum(rate(db_query_duration_ms_bucket[5m])) by (le)) > 200
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "Slow database queries"
          description: "95th percentile query time is {{ $value | printf \"%.0f\" }}ms (threshold: 200ms)"

      # Query rate anomaly
      - alert: HighDatabaseLoad
        expr: sum(rate(db_queries_total[5m])) > 1000
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "High database query rate"
          description: "Query rate is {{ $value | printf \"%.0f\" }} queries/sec"

  # ==================== CACHE ALERTS ====================
  - name: cache
    interval: 30s
    rules:
      # Low cache hit rate
      - alert: LowCacheHitRate
        expr: |
          (
            sum(rate(cache_hits_total[5m])) /
            (sum(rate(cache_hits_total[5m])) + sum(rate(cache_misses_total[5m])))
          ) * 100 < 70
        for: 10m
        labels:
          severity: warning
          category: cache
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate is {{ $value | printf \"%.1f\" }}% (threshold: 70%)"

      - alert: CriticalCacheHitRate
        expr: |
          (
            sum(rate(cache_hits_total[5m])) /
            (sum(rate(cache_hits_total[5m])) + sum(rate(cache_misses_total[5m])))
          ) * 100 < 50
        for: 5m
        labels:
          severity: critical
          category: cache
        annotations:
          summary: "Critical cache hit rate"
          description: "Cache hit rate is {{ $value | printf \"%.1f\" }}% (threshold: 50%). Performance degradation expected."

      # Cache key count
      - alert: HighCacheKeyCount
        expr: sum(cache_keys_count) > 100000
        for: 5m
        labels:
          severity: warning
          category: cache
        annotations:
          summary: "High number of cache keys"
          description: "Cache contains {{ $value | printf \"%.0f\" }} keys. Consider cache eviction policy."

  # ==================== WEBSOCKET ALERTS ====================
  - name: websocket
    interval: 30s
    rules:
      # Connection overload
      - alert: HighWebSocketConnections
        expr: sum(websocket_connections_active) > 5000
        for: 5m
        labels:
          severity: warning
          category: websocket
        annotations:
          summary: "High WebSocket connection count"
          description: "{{ $value | printf \"%.0f\" }} active WebSocket connections"

      - alert: CriticalWebSocketConnections
        expr: sum(websocket_connections_active) > 10000
        for: 2m
        labels:
          severity: critical
          category: websocket
        annotations:
          summary: "Critical WebSocket connection count"
          description: "{{ $value | printf \"%.0f\" }} active connections. May cause memory issues."

  # ==================== BUSINESS ALERTS - TICKETS ====================
  - name: tickets
    interval: 60s
    rules:
      # High ticket validation failure rate
      - alert: HighTicketValidationFailures
        expr: |
          (
            sum(rate(tickets_validated_total{status="failed"}[5m])) /
            sum(rate(tickets_validated_total[5m]))
          ) * 100 > 10
        for: 5m
        labels:
          severity: warning
          category: business
          domain: tickets
        annotations:
          summary: "High ticket validation failure rate"
          description: "{{ $value | printf \"%.1f\" }}% of ticket validations are failing"

      # No ticket sales (during active festival)
      - alert: NoTicketSales
        expr: sum(rate(tickets_sold_total[30m])) == 0
        for: 30m
        labels:
          severity: warning
          category: business
          domain: tickets
        annotations:
          summary: "No ticket sales in last 30 minutes"
          description: "No tickets have been sold in the last 30 minutes. Check payment system."

      # Ticket sales spike (potential fraud or viral)
      - alert: TicketSalesSpike
        expr: |
          sum(rate(tickets_sold_total[5m])) >
          (sum(rate(tickets_sold_total[1h])) * 5)
        for: 5m
        labels:
          severity: warning
          category: business
          domain: tickets
        annotations:
          summary: "Unusual ticket sales spike"
          description: "Ticket sales rate is 5x higher than the hourly average"

  # ==================== BUSINESS ALERTS - PAYMENTS ====================
  - name: payments
    interval: 60s
    rules:
      # Payment failures
      - alert: HighPaymentFailureRate
        expr: |
          (
            sum(rate(payments_total{status="failed"}[5m])) /
            sum(rate(payments_total[5m]))
          ) * 100 > 5
        for: 5m
        labels:
          severity: warning
          category: business
          domain: payments
        annotations:
          summary: "High payment failure rate"
          description: "{{ $value | printf \"%.1f\" }}% of payments are failing"

      - alert: CriticalPaymentFailureRate
        expr: |
          (
            sum(rate(payments_total{status="failed"}[5m])) /
            sum(rate(payments_total[5m]))
          ) * 100 > 20
        for: 2m
        labels:
          severity: critical
          category: business
          domain: payments
        annotations:
          summary: "Critical payment failure rate"
          description: "{{ $value | printf \"%.1f\" }}% of payments are failing. Revenue impact expected."

      # No payments (during business hours)
      - alert: NoPayments
        expr: sum(rate(payments_total[30m])) == 0
        for: 30m
        labels:
          severity: warning
          category: business
          domain: payments
        annotations:
          summary: "No payments processed in last 30 minutes"
          description: "Payment processing may be down"

  # ==================== BUSINESS ALERTS - CASHLESS ====================
  - name: cashless
    interval: 60s
    rules:
      # Cashless payment failures
      - alert: CashlessPaymentFailures
        expr: |
          sum(rate(cashless_payments_total{status="failed"}[5m])) > 0.5
        for: 5m
        labels:
          severity: warning
          category: business
          domain: cashless
        annotations:
          summary: "Cashless payment failures detected"
          description: "{{ $value | printf \"%.1f\" }} failed cashless payments per second"

      # High cashless transaction volume (potential fraud)
      - alert: HighCashlessVolume
        expr: |
          sum(rate(cashless_payments_total[5m])) > 100
        for: 5m
        labels:
          severity: warning
          category: business
          domain: cashless
        annotations:
          summary: "High cashless transaction volume"
          description: "{{ $value | printf \"%.0f\" }} transactions/sec. Verify normal activity."

      # Large topup amounts (fraud detection)
      - alert: LargeCashlessTopup
        expr: |
          max(increase(cashless_topup_amount_total[5m])) > 50000
        for: 1m
        labels:
          severity: warning
          category: business
          domain: cashless
        annotations:
          summary: "Large cashless topup detected"
          description: "Topup amount exceeds 500 EUR in 5 minutes. May require verification."

  # ==================== BUSINESS ALERTS - ZONES ====================
  - name: zones
    interval: 30s
    rules:
      # Zone at capacity
      - alert: ZoneAtCapacity
        expr: zone_occupancy_percentage > 90
        for: 5m
        labels:
          severity: warning
          category: business
          domain: zones
        annotations:
          summary: "Zone {{ $labels.zone_name }} at capacity"
          description: "Zone is at {{ $value | printf \"%.0f\" }}% capacity"

      - alert: ZoneOverCapacity
        expr: zone_occupancy_percentage > 100
        for: 1m
        labels:
          severity: critical
          category: business
          domain: zones
        annotations:
          summary: "Zone {{ $labels.zone_name }} over capacity"
          description: "Zone is at {{ $value | printf \"%.0f\" }}% capacity. Safety concern!"

      # Festival capacity
      - alert: FestivalHighCapacity
        expr: festival_capacity_percentage > 85
        for: 10m
        labels:
          severity: warning
          category: business
          domain: zones
        annotations:
          summary: "Festival {{ $labels.festival_id }} approaching capacity"
          description: "Festival is at {{ $value | printf \"%.0f\" }}% capacity"

      - alert: FestivalAtCapacity
        expr: festival_capacity_percentage > 95
        for: 5m
        labels:
          severity: critical
          category: business
          domain: zones
        annotations:
          summary: "Festival {{ $labels.festival_id }} at capacity"
          description: "Festival is at {{ $value | printf \"%.0f\" }}% capacity. Entry may need to be restricted."

  # ==================== VENDOR ALERTS ====================
  - name: vendors
    interval: 60s
    rules:
      # Vendor order failures
      - alert: VendorOrderFailures
        expr: |
          sum(rate(vendor_orders_total{status="failed"}[5m])) > 0.1
        for: 5m
        labels:
          severity: warning
          category: business
          domain: vendors
        annotations:
          summary: "Vendor order failures detected"
          description: "{{ $value | printf \"%.2f\" }} failed orders per second"

      # Low vendor activity (potential terminal issue)
      - alert: VendorInactive
        expr: |
          sum by (vendor_id) (increase(vendor_orders_total[30m])) == 0
        for: 30m
        labels:
          severity: info
          category: business
          domain: vendors
        annotations:
          summary: "Vendor {{ $labels.vendor_id }} inactive"
          description: "No orders for vendor in the last 30 minutes during operating hours"

  # ==================== SLA ALERTS ====================
  - name: sla
    interval: 60s
    rules:
      # API availability SLA
      - alert: SlaApiAvailability
        expr: |
          (
            sum(rate(http_requests_total{status=~"2..|3.."}[5m])) /
            sum(rate(http_requests_total[5m]))
          ) * 100 < 99.9
        for: 5m
        labels:
          severity: critical
          category: sla
        annotations:
          summary: "API availability below SLA"
          description: "API availability is {{ $value | printf \"%.2f\" }}% (SLA: 99.9%)"

      # Response time SLA
      - alert: SlaResponseTime
        expr: |
          histogram_quantile(0.95, sum(rate(http_request_duration_ms_bucket[5m])) by (le)) > 250
        for: 10m
        labels:
          severity: warning
          category: sla
        annotations:
          summary: "Response time above SLA target"
          description: "P95 response time is {{ $value | printf \"%.0f\" }}ms (target: 250ms)"

      # Payment success rate SLA
      - alert: SlaPaymentSuccess
        expr: |
          (
            sum(rate(payments_total{status="completed"}[1h])) /
            sum(rate(payments_total[1h]))
          ) * 100 < 99
        for: 15m
        labels:
          severity: critical
          category: sla
        annotations:
          summary: "Payment success rate below SLA"
          description: "Payment success rate is {{ $value | printf \"%.2f\" }}% (SLA: 99%)"
