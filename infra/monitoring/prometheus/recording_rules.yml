# Festival Platform - Prometheus Recording Rules
# Pre-computed metrics for dashboard performance

groups:
  # ==================== HTTP METRICS ====================
  - name: http_recording_rules
    interval: 30s
    rules:
      # Request rate by method and status
      - record: http:requests:rate5m
        expr: sum(rate(http_requests_total[5m])) by (method, status)

      # Total request rate
      - record: http:requests_total:rate5m
        expr: sum(rate(http_requests_total[5m]))

      # Error rate
      - record: http:errors:rate5m
        expr: sum(rate(http_errors_total[5m]))

      # Error percentage
      - record: http:error_percentage:rate5m
        expr: |
          (
            sum(rate(http_errors_total[5m])) /
            sum(rate(http_requests_total[5m]))
          ) * 100

      # Latency percentiles
      - record: http:request_duration_ms:p50
        expr: histogram_quantile(0.50, sum(rate(http_request_duration_ms_bucket[5m])) by (le))

      - record: http:request_duration_ms:p95
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_ms_bucket[5m])) by (le))

      - record: http:request_duration_ms:p99
        expr: histogram_quantile(0.99, sum(rate(http_request_duration_ms_bucket[5m])) by (le))

      # Latency by endpoint
      - record: http:request_duration_ms:p95:by_path
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_ms_bucket[5m])) by (le, path))

      # Availability (non-5xx responses)
      - record: http:availability:rate5m
        expr: |
          (
            sum(rate(http_requests_total{status!~"5.."}[5m])) /
            sum(rate(http_requests_total[5m]))
          ) * 100

  # ==================== DATABASE METRICS ====================
  - name: database_recording_rules
    interval: 30s
    rules:
      # Query rate by operation
      - record: db:queries:rate5m:by_operation
        expr: sum(rate(db_queries_total[5m])) by (operation)

      # Total query rate
      - record: db:queries_total:rate5m
        expr: sum(rate(db_queries_total[5m]))

      # Error rate
      - record: db:errors:rate5m
        expr: sum(rate(db_errors_total[5m]))

      # Query latency percentiles
      - record: db:query_duration_ms:p50
        expr: histogram_quantile(0.50, sum(rate(db_query_duration_ms_bucket[5m])) by (le))

      - record: db:query_duration_ms:p95
        expr: histogram_quantile(0.95, sum(rate(db_query_duration_ms_bucket[5m])) by (le))

      - record: db:query_duration_ms:p99
        expr: histogram_quantile(0.99, sum(rate(db_query_duration_ms_bucket[5m])) by (le))

      # Slow queries (>200ms)
      - record: db:slow_queries:rate5m
        expr: |
          sum(rate(db_query_duration_ms_count[5m])) -
          sum(rate(db_query_duration_ms_bucket{le="200"}[5m]))

  # ==================== CACHE METRICS ====================
  - name: cache_recording_rules
    interval: 30s
    rules:
      # Cache hit rate
      - record: cache:hit_rate:rate5m
        expr: |
          (
            sum(rate(cache_hits_total[5m])) /
            (sum(rate(cache_hits_total[5m])) + sum(rate(cache_misses_total[5m])))
          ) * 100

      # Cache operations rate
      - record: cache:operations:rate5m
        expr: sum(rate(cache_hits_total[5m])) + sum(rate(cache_misses_total[5m]))

      # Cache efficiency score (0-100)
      - record: cache:efficiency_score
        expr: |
          clamp_max(
            (
              sum(rate(cache_hits_total[5m])) /
              (sum(rate(cache_hits_total[5m])) + sum(rate(cache_misses_total[5m])) + 0.001)
            ) * 100,
            100
          )

  # ==================== WEBSOCKET METRICS ====================
  - name: websocket_recording_rules
    interval: 30s
    rules:
      # Total active connections
      - record: ws:connections:total
        expr: sum(websocket_connections_active)

      # Connections by namespace
      - record: ws:connections:by_namespace
        expr: sum(websocket_connections_active) by (namespace)

      # Message rate
      - record: ws:messages:rate5m
        expr: sum(rate(websocket_messages_total[5m]))

      # Message rate by direction
      - record: ws:messages:rate5m:by_direction
        expr: sum(rate(websocket_messages_total[5m])) by (direction)

  # ==================== BUSINESS METRICS - TICKETS ====================
  - name: tickets_recording_rules
    interval: 60s
    rules:
      # Tickets sold rate
      - record: tickets:sold:rate5m
        expr: sum(rate(tickets_sold_total[5m]))

      # Tickets sold by festival
      - record: tickets:sold:rate5m:by_festival
        expr: sum(rate(tickets_sold_total[5m])) by (festival_id)

      # Tickets sold by type
      - record: tickets:sold:rate5m:by_type
        expr: sum(rate(tickets_sold_total[5m])) by (ticket_type)

      # Total tickets sold (cumulative)
      - record: tickets:sold:total
        expr: sum(tickets_sold_total)

      # Tickets validated rate
      - record: tickets:validated:rate5m
        expr: sum(rate(tickets_validated_total[5m]))

      # Tickets validated by festival
      - record: tickets:validated:rate5m:by_festival
        expr: sum(rate(tickets_validated_total[5m])) by (festival_id)

      # Validation success rate
      - record: tickets:validation_success_rate:rate5m
        expr: |
          (
            sum(rate(tickets_validated_total{status="success"}[5m])) /
            sum(rate(tickets_validated_total[5m]))
          ) * 100

  # ==================== BUSINESS METRICS - PAYMENTS ====================
  - name: payments_recording_rules
    interval: 60s
    rules:
      # Payment rate
      - record: payments:total:rate5m
        expr: sum(rate(payments_total[5m]))

      # Payment rate by status
      - record: payments:total:rate5m:by_status
        expr: sum(rate(payments_total[5m])) by (status)

      # Payment success rate
      - record: payments:success_rate:rate5m
        expr: |
          (
            sum(rate(payments_total{status="completed"}[5m])) /
            sum(rate(payments_total[5m]))
          ) * 100

      # Total revenue rate (EUR)
      - record: payments:revenue_eur:rate5m
        expr: sum(rate(payments_amount_total{currency="EUR"}[5m])) / 100

      # Revenue by festival
      - record: payments:revenue_eur:rate5m:by_festival
        expr: sum(rate(payments_amount_total{currency="EUR"}[5m])) by (festival_id) / 100

      # Average payment amount
      - record: payments:average_amount_eur
        expr: |
          (sum(rate(payments_amount_total{currency="EUR"}[5m])) / 100) /
          (sum(rate(payments_total{status="completed"}[5m])) + 0.001)

  # ==================== BUSINESS METRICS - CASHLESS ====================
  - name: cashless_recording_rules
    interval: 60s
    rules:
      # Topup rate
      - record: cashless:topups:rate5m
        expr: sum(rate(cashless_topups_total[5m]))

      # Topup volume (EUR)
      - record: cashless:topup_volume_eur:rate5m
        expr: sum(rate(cashless_topup_amount_total{currency="EUR"}[5m])) / 100

      # Payment rate
      - record: cashless:payments:rate5m
        expr: sum(rate(cashless_payments_total[5m]))

      # Payment volume (EUR)
      - record: cashless:payment_volume_eur:rate5m
        expr: sum(rate(cashless_payment_amount_total{currency="EUR"}[5m])) / 100

      # Cashless usage rate
      - record: cashless:usage:rate5m
        expr: sum(rate(cashless_payments_total[5m])) + sum(rate(cashless_topups_total[5m]))

      # Average transaction amount
      - record: cashless:average_payment_eur
        expr: |
          (sum(rate(cashless_payment_amount_total{currency="EUR"}[5m])) / 100) /
          (sum(rate(cashless_payments_total[5m])) + 0.001)

      # Cashless adoption rate (payments vs topups)
      - record: cashless:turnover_ratio
        expr: |
          sum(rate(cashless_payment_amount_total[5m])) /
          (sum(rate(cashless_topup_amount_total[5m])) + 0.001)

  # ==================== BUSINESS METRICS - ZONES ====================
  - name: zones_recording_rules
    interval: 30s
    rules:
      # Total current attendees
      - record: zones:total_occupancy
        expr: sum(zone_occupancy_current)

      # Average occupancy percentage
      - record: zones:average_occupancy_percentage
        expr: avg(zone_occupancy_percentage)

      # Zone with highest occupancy
      - record: zones:max_occupancy_percentage
        expr: max(zone_occupancy_percentage)

      # Entry rate
      - record: zones:entries:rate5m
        expr: sum(rate(zone_entries_total[5m]))

      # Exit rate
      - record: zones:exits:rate5m
        expr: sum(rate(zone_exits_total[5m]))

      # Net flow (entries - exits)
      - record: zones:net_flow:rate5m
        expr: |
          sum(rate(zone_entries_total[5m])) -
          sum(rate(zone_exits_total[5m]))

      # Flow by zone
      - record: zones:net_flow:rate5m:by_zone
        expr: |
          sum(rate(zone_entries_total[5m])) by (zone_id) -
          sum(rate(zone_exits_total[5m])) by (zone_id)

  # ==================== BUSINESS METRICS - VENDORS ====================
  - name: vendors_recording_rules
    interval: 60s
    rules:
      # Order rate
      - record: vendors:orders:rate5m
        expr: sum(rate(vendor_orders_total[5m]))

      # Order rate by vendor
      - record: vendors:orders:rate5m:by_vendor
        expr: sum(rate(vendor_orders_total[5m])) by (vendor_id)

      # Revenue rate (EUR)
      - record: vendors:revenue_eur:rate5m
        expr: sum(rate(vendor_revenue_total{currency="EUR"}[5m])) / 100

      # Top vendor by orders
      - record: vendors:top_by_orders
        expr: topk(10, sum(rate(vendor_orders_total[5m])) by (vendor_id))

      # Average order value
      - record: vendors:average_order_eur
        expr: |
          (sum(rate(vendor_revenue_total{currency="EUR"}[5m])) / 100) /
          (sum(rate(vendor_orders_total{status="completed"}[5m])) + 0.001)

  # ==================== FESTIVAL SUMMARY METRICS ====================
  - name: festival_summary_rules
    interval: 60s
    rules:
      # Total active festivals
      - record: festival:active_count
        expr: count(festival_attendees_current > 0)

      # Total attendees across all festivals
      - record: festival:total_attendees
        expr: sum(festival_attendees_current)

      # Average capacity utilization
      - record: festival:average_capacity_percentage
        expr: avg(festival_capacity_percentage)

      # Total daily revenue (EUR)
      - record: festival:daily_revenue_eur
        expr: |
          sum(increase(payments_amount_total{currency="EUR"}[24h])) / 100

      # Total daily ticket sales
      - record: festival:daily_tickets_sold
        expr: sum(increase(tickets_sold_total[24h]))

      # Total daily cashless transactions
      - record: festival:daily_cashless_transactions
        expr: |
          sum(increase(cashless_payments_total[24h])) +
          sum(increase(cashless_topups_total[24h]))

  # ==================== SLA METRICS ====================
  - name: sla_recording_rules
    interval: 60s
    rules:
      # API availability (30-day rolling)
      - record: sla:api_availability:30d
        expr: |
          (
            sum(sum_over_time(http:availability:rate5m[30d])) /
            count(sum_over_time(http:availability:rate5m[30d]))
          )

      # API p95 latency (30-day rolling)
      - record: sla:api_latency_p95:30d
        expr: |
          avg_over_time(http:request_duration_ms:p95[30d])

      # Payment success rate (30-day rolling)
      - record: sla:payment_success_rate:30d
        expr: |
          avg_over_time(payments:success_rate:rate5m[30d])

      # Uptime indicator (1 = up, 0 = down)
      - record: sla:service_up
        expr: up{job="festival-api"}
