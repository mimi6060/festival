# ============================================
# Alertmanager Configuration Secret
# ============================================
# Standalone Alertmanager configuration for Festival Platform
# Use this if you're not using kube-prometheus-stack
# ============================================

apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-config
  namespace: monitoring
  labels:
    app.kubernetes.io/name: alertmanager
    app.kubernetes.io/component: config
    app.kubernetes.io/part-of: festival-platform
type: Opaque
stringData:
  alertmanager.yml: |
    global:
      # Resolve timeout
      resolve_timeout: 5m

      # SMTP configuration for email notifications
      smtp_smarthost: 'smtp.example.com:587'
      smtp_from: 'alerts@festival.fr'
      smtp_auth_username: 'alerts@festival.fr'
      smtp_auth_password: '${SMTP_PASSWORD}'
      smtp_require_tls: true

      # Slack API URL (set via environment variable or secret)
      slack_api_url: '${SLACK_WEBHOOK_URL}'

      # PagerDuty configuration (optional)
      # pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'

    # Templates
    templates:
      - '/etc/alertmanager/templates/*.tmpl'

    # Route tree
    route:
      # Default receiver
      receiver: 'slack-notifications'

      # Group alerts by these labels
      group_by: ['alertname', 'severity', 'namespace', 'festival_id']

      # Wait before sending first notification
      group_wait: 30s

      # Wait before sending subsequent notifications
      group_interval: 5m

      # Wait before resending same alert
      repeat_interval: 4h

      # Child routes
      routes:
        # Critical alerts - immediate
        - match:
            severity: critical
          receiver: 'slack-critical'
          group_wait: 10s
          repeat_interval: 1h
          continue: true

        - match:
            severity: critical
          receiver: 'pagerduty-critical'
          group_wait: 10s
          repeat_interval: 1h

        # Warning alerts
        - match:
            severity: warning
          receiver: 'slack-warnings'
          group_wait: 1m
          repeat_interval: 4h

        # Business/Festival-specific alerts
        - match_re:
            alertname: '^Festival.*|^Payment.*|^Ticket.*|^Cashless.*'
          receiver: 'slack-business'
          group_wait: 30s
          repeat_interval: 2h

        # Database alerts
        - match_re:
            alertname: '^PostgreSQL.*|^Database.*'
          receiver: 'slack-database'
          group_wait: 30s
          repeat_interval: 2h

        # Infrastructure alerts
        - match_re:
            alertname: '^Node.*|^Kubernetes.*|^Container.*'
          receiver: 'slack-infrastructure'
          group_wait: 1m
          repeat_interval: 4h

        # Watchdog (deadman's switch) - silenced
        - match:
            alertname: Watchdog
          receiver: 'null'

        # Info level - reduced noise
        - match:
            severity: info
          receiver: 'slack-info'
          group_wait: 5m
          repeat_interval: 12h

    # Receivers
    receivers:
      # Null receiver (for silencing)
      - name: 'null'

      # Default Slack notifications
      - name: 'slack-notifications'
        slack_configs:
          - channel: '#festival-alerts'
            send_resolved: true
            icon_emoji: ':bell:'
            title: '{{ template "slack.festival.title" . }}'
            text: '{{ template "slack.festival.text" . }}'
            actions:
              - type: button
                text: 'Runbook :notebook:'
                url: '{{ (index .Alerts 0).Annotations.runbook_url }}'
              - type: button
                text: 'Dashboard :chart_with_upwards_trend:'
                url: 'https://grafana.festival.fr'

      # Critical alerts - high priority
      - name: 'slack-critical'
        slack_configs:
          - channel: '#festival-critical'
            send_resolved: true
            color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
            icon_emoji: ':rotating_light:'
            title: ':rotating_light: CRITICAL: {{ .CommonAnnotations.summary }}'
            text: |
              *Alert:* {{ .CommonAnnotations.summary }}
              *Severity:* {{ .CommonLabels.severity }}
              *Namespace:* {{ .CommonLabels.namespace }}
              *Description:* {{ .CommonAnnotations.description }}

              {{ range .Alerts }}
              :small_red_triangle: *{{ .Labels.alertname }}*
              {{ .Annotations.description }}
              {{ end }}

              *Started:* {{ .Alerts.Firing | len }} firing, {{ .Alerts.Resolved | len }} resolved

      # Warning alerts
      - name: 'slack-warnings'
        slack_configs:
          - channel: '#festival-warnings'
            send_resolved: true
            color: '{{ if eq .Status "firing" }}warning{{ else }}good{{ end }}'
            icon_emoji: ':warning:'
            title: ':warning: Warning: {{ .CommonAnnotations.summary }}'
            text: |
              {{ .CommonAnnotations.description }}
              {{ range .Alerts }}
              • {{ .Annotations.description }}
              {{ end }}

      # Business alerts
      - name: 'slack-business'
        slack_configs:
          - channel: '#festival-business'
            send_resolved: true
            color: '{{ if eq .Status "firing" }}#ff9800{{ else }}good{{ end }}'
            icon_emoji: ':chart_with_upwards_trend:'
            title: ':chart_with_upwards_trend: Business Alert: {{ .CommonAnnotations.summary }}'
            text: |
              {{ .CommonAnnotations.description }}

              *Festival:* {{ .CommonLabels.festival_id }}
              *Impact:* {{ .CommonAnnotations.impact }}

              {{ range .Alerts }}
              • {{ .Annotations.description }}
              {{ end }}

      # Database alerts
      - name: 'slack-database'
        slack_configs:
          - channel: '#festival-database'
            send_resolved: true
            color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
            icon_emoji: ':floppy_disk:'
            title: ':floppy_disk: Database Alert: {{ .CommonAnnotations.summary }}'
            text: |
              {{ .CommonAnnotations.description }}

              *Database:* {{ .CommonLabels.datname }}
              *Instance:* {{ .CommonLabels.instance }}

      # Infrastructure alerts
      - name: 'slack-infrastructure'
        slack_configs:
          - channel: '#festival-infra'
            send_resolved: true
            icon_emoji: ':gear:'
            title: ':gear: Infra Alert: {{ .CommonAnnotations.summary }}'
            text: '{{ .CommonAnnotations.description }}'

      # Info level alerts
      - name: 'slack-info'
        slack_configs:
          - channel: '#festival-info'
            send_resolved: false
            icon_emoji: ':information_source:'
            title: ':information_source: {{ .CommonAnnotations.summary }}'
            text: '{{ .CommonAnnotations.description }}'

      # PagerDuty for critical on-call
      - name: 'pagerduty-critical'
        pagerduty_configs:
          - service_key: '${PAGERDUTY_SERVICE_KEY}'
            severity: critical
            description: '{{ .CommonAnnotations.summary }}'
            details:
              firing: '{{ .Alerts.Firing | len }}'
              resolved: '{{ .Alerts.Resolved | len }}'
              namespace: '{{ .CommonLabels.namespace }}'

      # Email for reports
      - name: 'email-reports'
        email_configs:
          - to: 'ops@festival.fr'
            send_resolved: true
            html: '{{ template "email.festival.html" . }}'

    # Inhibition rules
    inhibit_rules:
      # Critical inhibits warning for same alert
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'namespace']

      # Critical inhibits info
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'info'
        equal: ['namespace']

      # Warning inhibits info
      - source_match:
          severity: 'warning'
        target_match:
          severity: 'info'
        equal: ['alertname', 'namespace']

      # Node down inhibits all pod alerts on that node
      - source_match:
          alertname: 'NodeDown'
        target_match_re:
          alertname: '^(Pod|Container).*'
        equal: ['node']

      # Cluster unreachable inhibits all alerts
      - source_match:
          alertname: 'ClusterUnreachable'
        target_match_re:
          alertname: '.*'
        equal: ['cluster']

---
# Alertmanager Templates ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-templates
  namespace: monitoring
  labels:
    app.kubernetes.io/name: alertmanager
    app.kubernetes.io/component: templates
    app.kubernetes.io/part-of: festival-platform
data:
  festival.tmpl: |
    {{ define "slack.festival.title" -}}
    [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonAnnotations.summary }}
    {{- end }}

    {{ define "slack.festival.text" -}}
    {{ range .Alerts }}
    *Alert:* {{ .Annotations.summary }}
    *Description:* {{ .Annotations.description }}
    *Severity:* {{ .Labels.severity }}
    *Namespace:* {{ .Labels.namespace }}
    {{ if .Labels.festival_id }}*Festival:* {{ .Labels.festival_id }}{{ end }}
    *Started:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
    {{ if .EndsAt }}*Ended:* {{ .EndsAt.Format "2006-01-02 15:04:05" }}{{ end }}
    ---
    {{ end }}
    {{- end }}

    {{ define "email.festival.html" -}}
    <!DOCTYPE html>
    <html>
    <head>
      <style>
        body { font-family: Arial, sans-serif; }
        .alert { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .critical { background-color: #ffebee; border-left: 4px solid #f44336; }
        .warning { background-color: #fff3e0; border-left: 4px solid #ff9800; }
        .info { background-color: #e3f2fd; border-left: 4px solid #2196f3; }
        .resolved { background-color: #e8f5e9; border-left: 4px solid #4caf50; }
      </style>
    </head>
    <body>
      <h2>Festival Platform Alerts</h2>
      <p>Status: {{ .Status | toUpper }}</p>
      {{ range .Alerts }}
      <div class="alert {{ .Labels.severity }}{{ if eq $.Status "resolved" }} resolved{{ end }}">
        <h3>{{ .Annotations.summary }}</h3>
        <p>{{ .Annotations.description }}</p>
        <p><strong>Severity:</strong> {{ .Labels.severity }}</p>
        <p><strong>Namespace:</strong> {{ .Labels.namespace }}</p>
        {{ if .Labels.festival_id }}<p><strong>Festival:</strong> {{ .Labels.festival_id }}</p>{{ end }}
      </div>
      {{ end }}
    </body>
    </html>
    {{- end }}
