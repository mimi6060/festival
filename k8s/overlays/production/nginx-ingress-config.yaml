# ============================================================================
# NGINX Ingress Controller Production Configuration
# Festival Management Platform
# ============================================================================
# Optimized NGINX configuration for high-traffic production workloads
# ============================================================================
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-ingress-controller
  namespace: ingress-nginx
  labels:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/component: controller
    environment: production
data:
  # -----------------------------------------------------------------------------
  # Worker Configuration
  # -----------------------------------------------------------------------------
  worker-processes: "auto"
  worker-connections: "65536"
  worker-cpu-affinity: "auto"

  # -----------------------------------------------------------------------------
  # Connection Handling
  # -----------------------------------------------------------------------------
  keep-alive: "75"
  keep-alive-requests: "10000"
  upstream-keepalive-connections: "320"
  upstream-keepalive-timeout: "60"
  upstream-keepalive-requests: "10000"

  # -----------------------------------------------------------------------------
  # Proxy Configuration
  # -----------------------------------------------------------------------------
  proxy-body-size: "100m"
  proxy-buffer-size: "16k"
  proxy-buffers-number: "4"
  proxy-connect-timeout: "10"
  proxy-read-timeout: "60"
  proxy-send-timeout: "60"
  proxy-next-upstream: "error timeout http_502 http_503 http_504"
  proxy-next-upstream-tries: "3"
  proxy-next-upstream-timeout: "30"
  proxy-protocol-header-timeout: "5s"

  # -----------------------------------------------------------------------------
  # SSL/TLS Configuration
  # -----------------------------------------------------------------------------
  ssl-protocols: "TLSv1.2 TLSv1.3"
  ssl-ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384"
  ssl-prefer-server-ciphers: "true"
  ssl-session-cache: "true"
  ssl-session-cache-size: "100m"
  ssl-session-tickets: "true"
  ssl-session-timeout: "1d"
  ssl-redirect: "true"
  force-ssl-redirect: "true"
  hsts: "true"
  hsts-max-age: "31536000"
  hsts-include-subdomains: "true"
  hsts-preload: "true"

  # -----------------------------------------------------------------------------
  # HTTP/2 and HTTP/3
  # -----------------------------------------------------------------------------
  use-http2: "true"
  http2-max-field-size: "8k"
  http2-max-header-size: "32k"
  http2-max-requests: "10000"

  # -----------------------------------------------------------------------------
  # Compression
  # -----------------------------------------------------------------------------
  use-gzip: "true"
  gzip-level: "5"
  gzip-min-length: "256"
  gzip-types: "application/javascript application/json application/xml application/x-javascript image/svg+xml text/css text/javascript text/plain text/xml"

  # -----------------------------------------------------------------------------
  # Security Headers
  # -----------------------------------------------------------------------------
  server-tokens: "false"
  hide-headers: "X-Powered-By,Server"
  add-headers: "ingress-nginx/custom-headers"

  # -----------------------------------------------------------------------------
  # Rate Limiting
  # -----------------------------------------------------------------------------
  limit-req-status-code: "429"
  limit-conn-status-code: "429"

  # -----------------------------------------------------------------------------
  # Logging
  # -----------------------------------------------------------------------------
  enable-access-log-for-default-backend: "true"
  log-format-upstream: '{"time":"$time_iso8601","remote_addr":"$remote_addr","x_forwarded_for":"$proxy_add_x_forwarded_for","request_id":"$req_id","remote_user":"$remote_user","bytes_sent":$bytes_sent,"request_time":$request_time,"status":$status,"host":"$host","request_proto":"$server_protocol","path":"$uri","request_query":"$args","request_length":$request_length,"method":"$request_method","http_referrer":"$http_referer","http_user_agent":"$http_user_agent","upstream_addr":"$upstream_addr","upstream_status":"$upstream_status","upstream_response_time":"$upstream_response_time","upstream_connect_time":"$upstream_connect_time"}'
  log-format-escape-json: "true"

  # -----------------------------------------------------------------------------
  # Client Configuration
  # -----------------------------------------------------------------------------
  client-body-buffer-size: "16k"
  client-body-timeout: "60"
  client-header-buffer-size: "4k"
  client-header-timeout: "60"
  large-client-header-buffers: "4 16k"

  # -----------------------------------------------------------------------------
  # Load Balancing
  # -----------------------------------------------------------------------------
  load-balance: "ewma"
  retry-non-idempotent: "true"

  # -----------------------------------------------------------------------------
  # WebSocket Configuration
  # -----------------------------------------------------------------------------
  proxy-read-timeout: "3600"
  proxy-send-timeout: "3600"

  # -----------------------------------------------------------------------------
  # Custom Error Pages
  # -----------------------------------------------------------------------------
  custom-http-errors: "404,500,502,503,504"
  default-backend-service: "festival-prod/error-pages"

  # -----------------------------------------------------------------------------
  # Monitoring
  # -----------------------------------------------------------------------------
  enable-opentracing: "true"
  zipkin-collector-host: "zipkin.monitoring.svc.cluster.local"
  enable-prometheus-metrics: "true"

---
# Custom Security Headers ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: custom-headers
  namespace: ingress-nginx
data:
  X-Frame-Options: "SAMEORIGIN"
  X-Content-Type-Options: "nosniff"
  X-XSS-Protection: "1; mode=block"
  Referrer-Policy: "strict-origin-when-cross-origin"
  Permissions-Policy: "accelerometer=(), camera=(), geolocation=(self), gyroscope=(), magnetometer=(), microphone=(), payment=(self), usb=()"
  Content-Security-Policy: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com https://www.google-analytics.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https: blob:; connect-src 'self' https://api.stripe.com https://www.google-analytics.com wss:; frame-src 'self' https://js.stripe.com https://hooks.stripe.com; object-src 'none'; base-uri 'self'; form-action 'self';"

---
# NGINX Ingress Controller Deployment Patch
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ingress-nginx-controller
  namespace: ingress-nginx
spec:
  replicas: 5
  template:
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - ingress-nginx
                topologyKey: kubernetes.io/hostname
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: node-type
                    operator: In
                    values:
                      - ingress
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: ingress-nginx
      containers:
        - name: controller
          resources:
            requests:
              cpu: "500m"
              memory: "512Mi"
            limits:
              cpu: "2000m"
              memory: "2Gi"
          args:
            - /nginx-ingress-controller
            - --election-id=ingress-controller-leader
            - --controller-class=k8s.io/ingress-nginx
            - --ingress-class=nginx
            - --configmap=$(POD_NAMESPACE)/nginx-ingress-controller
            - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services
            - --udp-services-configmap=$(POD_NAMESPACE)/udp-services
            - --validating-webhook=:8443
            - --validating-webhook-certificate=/usr/local/certificates/cert
            - --validating-webhook-key=/usr/local/certificates/key
            - --enable-metrics=true
            - --metrics-per-host=true
            - --publish-status-address=

---
# HPA for NGINX Ingress Controller
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: ingress-nginx-controller
  namespace: ingress-nginx
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: ingress-nginx-controller
  minReplicas: 5
  maxReplicas: 20
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Pods
          value: 1
          periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
        - type: Pods
          value: 5
          periodSeconds: 30
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 60
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 70
    - type: Pods
      pods:
        metric:
          name: nginx_ingress_controller_nginx_process_connections
        target:
          type: AverageValue
          averageValue: "5000"

---
# PodDisruptionBudget for NGINX Ingress
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: ingress-nginx-controller
  namespace: ingress-nginx
spec:
  minAvailable: 3
  selector:
    matchLabels:
      app.kubernetes.io/name: ingress-nginx
      app.kubernetes.io/component: controller
